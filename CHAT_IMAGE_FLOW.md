# Chat Image Attachments - Visual Flow

## ğŸ¯ Feature Overview

Users can attach images to chat messages in ALL phase chats, with preview, inline display, and download capabilities.

## ğŸ“¸ User Interface Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PHASE CHAT PANEL                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Previous Messages â†‘                                         â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ‘¤ Alice  2:15 PM                                     â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚ "Here's the color scheme for the bedroom:"          â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚  â”‚
â”‚  â”‚  â”‚                         â”‚ â¬‡ [hover shows]       â”‚  â”‚
â”‚  â”‚  â”‚   [Image Preview]       â”‚                        â”‚  â”‚
â”‚  â”‚  â”‚   512x256px max         â”‚                        â”‚  â”‚
â”‚  â”‚  â”‚                         â”‚                        â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚  Click image â†’ Opens full size in new tab           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  MESSAGE INPUT AREA                                          â”‚
â”‚                                                              â”‚
â”‚  [Image Preview - if selected]                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚  â”‚ thumbnail.jpg   [X]â”‚  â† Click X to remove                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Type message... @mention              ğŸ“         Sendâ”‚  â”‚
â”‚  â”‚                                        â†‘              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                          â”‚                   â”‚
â”‚                                   Click to attach image     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Upload Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User    â”‚
â”‚  Action  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ 1. Clicks paperclip icon ğŸ“
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  File Picker     â”‚
â”‚  Opens           â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ 2. Selects image file
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client Validation       â”‚
â”‚  â€¢ Type: JPEG/PNG/WebP   â”‚
â”‚  â€¢ Size: < 5MB           â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â”€ âŒ Invalid â†’ Toast Error
     â”‚
     â”‚ âœ… Valid
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Preview Generated   â”‚
â”‚  FileReader API      â”‚
â”‚  Shows thumbnail     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ 3. User adds optional text
     â”‚ 4. Clicks "Send"
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FormData Created        â”‚
â”‚  â€¢ content (text)        â”‚
â”‚  â€¢ mentions (array)      â”‚
â”‚  â€¢ image (File)          â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ POST /api/chat/[stageId]
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Server API                  â”‚
â”‚  /api/chat/[stageId]/route   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ 5. Validates image
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Server Validation       â”‚
â”‚  â€¢ Re-check type         â”‚
â”‚  â€¢ Re-check size         â”‚
â”‚  â€¢ Check auth            â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â”€ âŒ Invalid â†’ 400 Error
     â”‚
     â”‚ âœ… Valid
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Upload to Vercel Blob       â”‚
â”‚  Path: orgs/{orgId}/chat/    â”‚
â”‚        {stageId}/chat_xxx    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ 6. Get URL
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Save to Database            â”‚
â”‚  ChatMessage {               â”‚
â”‚    content: "...",           â”‚
â”‚    imageUrl: "https://...",  â”‚
â”‚    imageFileName: "..."      â”‚
â”‚  }                           â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ 7. Return message
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client Updates UI       â”‚
â”‚  â€¢ Clears input          â”‚
â”‚  â€¢ Removes preview       â”‚
â”‚  â€¢ Adds message to chat  â”‚
â”‚  â€¢ Shows toast success   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ’¾ Data Storage Structure

```
Vercel Blob Storage:
â””â”€â”€ orgs/
    â””â”€â”€ {orgId}/
        â””â”€â”€ chat/
            â””â”€â”€ {stageId}/
                â”œâ”€â”€ chat_abc123.jpg
                â”œâ”€â”€ chat_def456.png
                â””â”€â”€ chat_ghi789.webp

Database (PostgreSQL):
ChatMessage Table:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id       â”‚ content     â”‚ imageUrl             â”‚ imageFileName  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ msg_001  â”‚ "Check it!" â”‚ https://blob.../x.jpgâ”‚ bedroom.jpg    â”‚
â”‚ msg_002  â”‚ "(Image)"   â”‚ https://blob.../y.pngâ”‚ colors.png     â”‚
â”‚ msg_003  â”‚ "Great!"    â”‚ null                 â”‚ null           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¨ Component Architecture

```
PhaseChat Component
â”œâ”€â”€ State Management
â”‚   â”œâ”€â”€ messages: ChatMessage[]
â”‚   â”œâ”€â”€ selectedImage: File | null
â”‚   â”œâ”€â”€ imagePreview: string | null
â”‚   â””â”€â”€ sending: boolean
â”‚
â”œâ”€â”€ Event Handlers
â”‚   â”œâ”€â”€ handleImageSelect(e)
â”‚   â”‚   â””â”€â”€ Validates â†’ Creates preview
â”‚   â”œâ”€â”€ removeImage()
â”‚   â”‚   â””â”€â”€ Clears selection & preview
â”‚   â””â”€â”€ sendMessage(content, mentions)
â”‚       â””â”€â”€ FormData â†’ API â†’ Update UI
â”‚
â””â”€â”€ UI Components
    â”œâ”€â”€ Input Area
    â”‚   â”œâ”€â”€ Image Preview (if selected)
    â”‚   â”œâ”€â”€ MentionTextarea
    â”‚   â””â”€â”€ Paperclip Button
    â”‚
    â””â”€â”€ Messages Display
        â””â”€â”€ For each message:
            â”œâ”€â”€ Author & Timestamp
            â”œâ”€â”€ Text Content (if any)
            â””â”€â”€ Image Display (if imageUrl)
                â”œâ”€â”€ Preview (max 512x256)
                â”œâ”€â”€ Download Button (hover)
                â””â”€â”€ Click â†’ Open full size
```

## ğŸ” Security Flow

```
Client Side:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  File Type Check        â”‚
â”‚  .jpg, .png, .webp, .gifâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ âœ… Pass
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  File Size Check        â”‚
â”‚  Maximum 5MB            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ âœ… Pass
        â–¼
     [Upload]

Server Side:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Authentication         â”‚
â”‚  Valid session required â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ âœ… Auth
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Re-validate Type       â”‚
â”‚  Server-side check      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ âœ… Pass
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Re-validate Size       â”‚
â”‚  Server-side check      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ âœ… Pass
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Org-Scoped Path        â”‚
â”‚  User can only upload   â”‚
â”‚  to own organization    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ âœ… Authorized
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Upload to Blob         â”‚
â”‚  Secure storage         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š API Request/Response

### Request (With Image)
```http
POST /api/chat/[stageId]
Content-Type: multipart/form-data

FormData {
  content: "Check this out!"
  mentions: '["user_123"]'
  image: File (binary data)
}
```

### Request (Text Only)
```http
POST /api/chat/[stageId]
Content-Type: application/json

{
  "content": "Just text message",
  "mentions": ["user_123"]
}
```

### Response
```json
{
  "success": true,
  "message": {
    "id": "msg_xyz789",
    "content": "Check this out!",
    "imageUrl": "https://blob.vercel-storage.com/...",
    "imageFileName": "bedroom-design.jpg",
    "authorId": "user_456",
    "stageId": "stage_789",
    "createdAt": "2025-01-31T01:30:00.000Z",
    "author": {
      "id": "user_456",
      "name": "John Doe",
      "role": "DESIGNER",
      "image": "https://..."
    },
    "mentions": [...]
  }
}
```

## âš¡ Performance Considerations

```
Client Side:
â”œâ”€â”€ Preview Generation
â”‚   â””â”€â”€ FileReader.readAsDataURL()
â”‚       â””â”€â”€ Async, non-blocking
â”‚
â”œâ”€â”€ Image Upload
â”‚   â””â”€â”€ FormData multipart upload
â”‚       â””â”€â”€ Shows loading state
â”‚
â””â”€â”€ Message Display
    â””â”€â”€ Images loaded lazily
        â””â”€â”€ Browser native lazy loading

Server Side:
â”œâ”€â”€ Image Processing
â”‚   â””â”€â”€ Direct Blob upload (no resize)
â”‚       â””â”€â”€ Fast, ~100-500ms
â”‚
â”œâ”€â”€ Database Write
â”‚   â””â”€â”€ Single INSERT query
â”‚       â””â”€â”€ ~50ms
â”‚
â””â”€â”€ Response
    â””â”€â”€ Returns immediately after save
        â””â”€â”€ Total: ~200-600ms
```

## ğŸ¯ Where Feature is Used

```
Application Structure:
â””â”€â”€ All Phase Chats
    â”œâ”€â”€ Design Concept Workspace âœ…
    â”œâ”€â”€ Bedroom Design Workspace âœ…
    â”œâ”€â”€ FFE Stage âœ…
    â”œâ”€â”€ Drawings Stage âœ…
    â”œâ”€â”€ Rendering Workspace âœ…
    â””â”€â”€ Client Approval Workspace âœ…

Each uses <PhaseChat /> component
    Props: { stageId, stageName, className }
    Location: Right sidebar or dedicated panel
```

## ğŸš€ Ready to Test!

The feature is **LIVE** and ready to use. Navigate to any phase with chat and start uploading images!
