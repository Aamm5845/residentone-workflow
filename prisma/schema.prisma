generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())
  used      Boolean  @default(false)

  @@unique([email, token])
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Business Profile for invoicing
  logoUrl          String?
  businessName     String? // Legal business name (may differ from "name")
  businessAddress  String?
  businessCity     String?
  businessProvince String?
  businessPostal   String?
  businessCountry  String? @default("Canada")
  businessPhone    String?
  businessEmail    String?

  // Tax Registration Numbers
  neqNumber String? // NEQ - Numéro d'entreprise du Québec (Quebec business number)
  gstNumber String? // GST registration number
  qstNumber String? // QST registration number (Quebec)

  // Default Tax Rates
  defaultGstRate Decimal? @default(5.0) // GST 5%
  defaultQstRate Decimal? @default(9.975) // QST 9.975%

  // Payment Instructions
  wireInstructions  String? @db.Text
  checkInstructions String? @db.Text
  etransferEmail    String? // Email for Interac e-Transfer

  clients        Client[]
  contractors    Contractor[]
  projects       Project[]
  tags           Tag[]
  users          User[]
  chatMessages   ChatMessage[]  @relation("OrgChatMessages")
  savedAddresses SavedAddress[]
  programaItems  ProgramaItem[] @relation("OrgProgramaItems")
  budgetQuotes      BudgetQuote[]      @relation("BudgetQuoteOrg")
  plaidConnections  PlaidConnection[]
}

// Shipping address phonebook - saved addresses for quick selection
model SavedAddress {
  id    String       @id @default(cuid())
  orgId String
  org   Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  name       String // e.g., "Office", "Warehouse", "Client Showroom"
  street     String
  city       String
  province   String
  postalCode String
  country    String @default("Canada")

  isDefault Boolean  @default(false) // Default shipping address
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId])
}

model User {
  id                          String                      @id @default(cuid())
  name                        String?
  email                       String                      @unique
  emailVerified               DateTime?
  image                       String?
  password                    String?
  role                        UserRole                    @default(DESIGNER)
  orgId                       String?
  phoneNumber                 String?
  emailNotificationsEnabled   Boolean                     @default(true)
  smsNotificationsEnabled     Boolean                     @default(false)
  mustChangePassword          Boolean                     @default(false)
  canSeeBilling               Boolean                     @default(false)
  canSeeFinancials            Boolean                     @default(false)
  approvalStatus              UserApprovalStatus          @default(PENDING)
  approvedAt                  DateTime?
  approvedBy                  String?
  createdAt                   DateTime                    @default(now())
  updatedAt                   DateTime                    @updatedAt
  accounts                    Account[]
  activities                  Activity[]                  @relation("ActivityUser")
  activityLogs                ActivityLog[]               @relation("ActivityLogActor")
  decidedApprovals            Approval[]                  @relation("DecidedByUser")
  sentApprovals               Approval[]                  @relation("SentByUser")
  uploadedAssets              Asset[]                     @relation("UploadedByUser")
  uploadedSourceFiles         ProjectSource[]             @relation("UploadedSourceFiles")
  assetPins                   AssetPin[]                  @relation("UserAssetPins")
  assetTags                   AssetTag[]                  @relation("UserAssetTags")
  chatMentions                ChatMention[]
  chatMessages                ChatMessage[]
  chatMessageReactions        ChatMessageReaction[]       @relation("ChatMessageReactions")
  completedChecklists         ChecklistItem[]             @relation("ChecklistCompletedBy")
  createdChecklists           ChecklistItem[]             @relation("ChecklistCreatedBy")
  clientAccessTokens          ClientAccessToken[]         @relation("ClientAccessTokenCreatedBy")
  clientApprovalActivities    ClientApprovalActivity[]
  aaronApprovalVersions       ClientApprovalVersion[]     @relation("ClientApprovalAaronApprovedBy")
  sentClientApprovalVersions  ClientApprovalVersion[]     @relation("ClientApprovalSentBy")
  comments                    Comment[]
  commentLikes                CommentLike[]               @relation("UserCommentLikes")
  commentPins                 CommentPin[]                @relation("UserCommentPins")
  commentTags                 CommentTag[]                @relation("UserCommentTags")
  completedDesignConceptItems DesignConceptItem[]         @relation("DesignConceptItemCompletedBy")
  createdDesignConceptItems   DesignConceptItem[]         @relation("DesignConceptItemCreatedBy")
  updatedDesignConceptItems   DesignConceptItem[]         @relation("DesignConceptItemUpdatedBy")
  designConceptItemNotes      DesignConceptItemNote[]     @relation("DesignConceptItemNoteAuthor")
  completedSections           DesignSection[]             @relation("CompletedByUserSection")
  createdSections             DesignSection[]             @relation("CreatedByUserSection")
  updatedSections             DesignSection[]             @relation("UpdatedByUserSection")
  createdFFEItems             FFEItem[]                   @relation("CreatedByUserFFE")
  updatedFFEItems             FFEItem[]                   @relation("UpdatedByUserFFE")
  createdFFEItemStatuses      FFEItemStatus[]             @relation("FFEItemStatusCreatedBy")
  updatedFFEItemStatuses      FFEItemStatus[]             @relation("FFEItemStatusUpdatedBy")
  createdFFETemplates         FFETemplate[]               @relation("FFETemplateCreatedBy")
  updatedFFETemplates         FFETemplate[]               @relation("FFETemplateUpdatedBy")
  floorplanApprovalActivities FloorplanApprovalActivity[]
  aaronFloorplanApprovals     FloorplanApprovalVersion[]  @relation("FloorplanAaronApprovedBy")
  sentFloorplanApprovals      FloorplanApprovalVersion[]  @relation("FloorplanSentBy")
  assignedIssues              Issue[]                     @relation("IssueAssignee")
  reportedIssues              Issue[]                     @relation("IssueReporter")
  resolvedIssues              Issue[]                     @relation("IssueResolver")
  issueComments               IssueComment[]              @relation("IssueCommentAuthor")
  createdProjects             Project[]                   @relation("CreatedByUser")
  updatedProjects             Project[]                   @relation("UpdatedByUser")
  assignedTasks               ProjectUpdateTask[]         @relation("TaskAssignee")
  createdTasks                ProjectUpdateTask[]         @relation("TaskCreatedBy")
  renderingNotes              RenderingNote[]             @relation("RenderingNoteAuthor")
  completedRenderingVersions  RenderingVersion[]          @relation("RenderingVersionCompletedBy")
  createdRenderingVersions    RenderingVersion[]          @relation("RenderingVersionCreatedBy")
  updatedRenderingVersions    RenderingVersion[]          @relation("RenderingVersionUpdatedBy")
  createdRooms                Room[]                      @relation("CreatedByUserRoom")
  updatedRooms                Room[]                      @relation("UpdatedByUserRoom")
  createdFFEInstances         RoomFFEInstance[]           @relation("RoomFFEInstanceCreatedBy")
  updatedFFEInstances         RoomFFEInstance[]           @relation("RoomFFEInstanceUpdatedBy")
  createdRoomFFEItems         RoomFFEItem[]               @relation("RoomFFEItemCreatedBy")
  updatedRoomFFEItems         RoomFFEItem[]               @relation("RoomFFEItemUpdatedBy")
  createdFFESpecLinks         FFESpecLink[]               @relation("FFESpecLinkCreatedBy")
  sessions                    Session[]
  smsConversations            SmsConversation[]           @relation("UserSmsConversations")
  specBookGenerations         SpecBookGeneration[]        @relation("SpecBookGeneratedBy")
  assignedStages              Stage[]                     @relation("AssignedToUser")
  completedStages             Stage[]                     @relation("CompletedByUserStage")
  createdStages               Stage[]                     @relation("CreatedByUserStage")
  updatedStages               Stage[]                     @relation("UpdatedByUserStage")
  organization                Organization?               @relation(fields: [orgId], references: [id], onDelete: Cascade)
  // Time tracking relations
  timeEntries                 TimeEntry[]                 @relation("UserTimeEntries")
  timeEntryEdits              TimeEntryEdit[]             @relation("UserTimeEntryEdits")
  timeSettings                UserTimeSettings?           @relation("UserTimeSettings")
  offDays                     UserOffDay[]                @relation("UserOffDays")
  // Floorplan chat relations
  floorplanChatMessages       FloorplanChatMessage[]      @relation("FloorplanChatAuthor")
  floorplanChatMentions       FloorplanChatMention[]      @relation("FloorplanChatMentioned")
  floorplanChatReactions      FloorplanChatReaction[]     @relation("FloorplanChatReactor")
  // RFQ system relations
  rfqsSentBy                  RFQ[]                       @relation("RFQSentBy")
  rfqsCreatedBy               RFQ[]                       @relation("RFQCreatedBy")
  rfqsUpdatedBy               RFQ[]                       @relation("RFQUpdatedBy")
  supplierQuotesReviewed      SupplierQuote[]             @relation("QuoteReviewedBy")
  supplierQuotesAccepted      SupplierQuote[]             @relation("QuoteAcceptedBy")
  matchApprovedLineItems      SupplierQuoteLineItem[]     @relation("MatchApprovedBy")
  quoteLineItemsAcceptedBy    SupplierQuoteLineItem[]     @relation("QuoteLineAcceptedBy")
  clientQuotesSentBy          ClientQuote[]               @relation("ClientQuoteSentBy")
  clientQuotesCreatedBy       ClientQuote[]               @relation("ClientQuoteCreatedBy")
  clientQuotesUpdatedBy       ClientQuote[]               @relation("ClientQuoteUpdatedBy")
  clientQuoteActivities       ClientQuoteActivity[]       @relation("ClientQuoteActivityUser")
  paymentsConfirmed           Payment[]                   @relation("PaymentConfirmedBy")
  paymentsReconciled          Payment[]                   @relation("PaymentReconciledBy")
  paymentsCreated             Payment[]                   @relation("PaymentCreatedBy")
  savedPaymentMethods         SavedPaymentMethod[]        @relation("PaymentMethodCreatedBy")
  ordersCreatedBy             Order[]                     @relation("OrderCreatedBy")
  ordersUpdatedBy             Order[]                     @relation("OrderUpdatedBy")
  orderActivities             OrderActivity[]             @relation("OrderActivityUser")
  rfqDocumentsUploaded        RFQDocument[]               @relation("RFQDocumentUploadedBy")
  rfqActivities               RFQActivity[]               @relation("RFQActivityUser")
  supplierMessagesSent        SupplierMessage[]           @relation("SupplierMessageSender")
  supplierMessagesRead        SupplierMessage[]           @relation("SupplierMessageReadBy")
  shopDrawingsReviewed        SupplierShopDrawing[]       @relation("ShopDrawingReviewedBy")
  // Item quote request and activity tracking
  itemQuoteRequestsSent       ItemQuoteRequest[]          @relation("QuoteRequestSentBy")
  itemActivities              ItemActivity[]              @relation("ItemActivityActor")
  // Spec share links
  createdSpecShareLinks       SpecShareLink[]             @relation("SpecShareLinkCreatedBy")
  // Programa import
  programaItemsLinked         ProgramaItem[]              @relation("ProgramaLinkedBy")
  // Budget quotes
  budgetQuotesCreated         BudgetQuote[]               @relation("BudgetQuoteCreatedBy")
  // Billing system
  proposalsCreated            Proposal[]                  @relation("ProposalCreatedBy")
  billingInvoicesCreated      BillingInvoice[]            @relation("BillingInvoiceCreatedBy")
  billingPaymentsConfirmed    BillingPayment[]            @relation("BillingPaymentConfirmedBy")
  // Plaid connections
  plaidConnections            PlaidConnection[]           @relation("PlaidConnectedBy")
}

model Client {
  id           String       @id @default(cuid())
  name         String
  email        String
  phone        String?
  orgId        String
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  company      String?
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  projects     Project[]

  // Billing Information
  billingName       String?  // Contact name for billing (e.g., "Accounts Payable")
  billingEmail      String?  // Email for invoices
  billingAddress    String?  // Street address
  billingCity       String?
  billingProvince   String?  // Province/State
  billingPostalCode String?
  billingCountry    String?  @default("Canada")

  @@unique([orgId, email])
}

model Contractor {
  id                 String              @id @default(cuid())
  businessName       String
  contactName        String?
  email              String
  phone              String?
  address            String?
  type               ContractorType      @default(CONTRACTOR)
  specialty          String?
  notes              String?
  isActive           Boolean             @default(true)
  orgId              String
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  organization       Organization        @relation(fields: [orgId], references: [id], onDelete: Cascade)
  projectContractors ProjectContractor[]
  projectUpdateTasks ProjectUpdateTask[]

  @@unique([orgId, email])
  @@index([orgId, type])
  @@index([orgId, isActive])
}

model ProjectContractor {
  id           String     @id @default(cuid())
  projectId    String
  contractorId String
  role         String?
  startDate    DateTime?
  endDate      DateTime?
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  contractor   Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  project      Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, contractorId])
  @@index([projectId])
  @@index([contractorId])
}

model Project {
  id                        String                     @id @default(cuid())
  name                      String
  description               String?
  type                      ProjectType                @default(RESIDENTIAL)
  status                    ProjectStatus              @default(DRAFT)
  statusManuallySet         Boolean                    @default(false)
  clientId                  String
  dueDate                   DateTime?
  budget                    Float?
  dropboxFolder             String?
  linkedDropboxFolders      Json?
  orgId                     String
  createdById               String
  updatedById               String?
  createdAt                 DateTime                   @default(now())
  updatedAt                 DateTime                   @updatedAt
  coverImages               Json?
  address                   String?
  streetAddress             String?
  city                      String?
  province                  String?
  postalCode                String?
  hasFloorplanApproval      Boolean                    @default(true)
  hasSpecBook               Boolean                    @default(true)
  hasProjectUpdates         Boolean                    @default(true)
  hasBillingProcurement     Boolean                    @default(true)
  phasePricing              Json?
  shareSettings             Json?
  approvals                 Approval[]
  assets                    Asset[]                    @relation("ProjectAssets")
  clientAccessTokens        ClientAccessToken[]        @relation("ClientAccessTokenProject")
  comments                  Comment[]
  floorplanApprovalVersions FloorplanApprovalVersion[]
  floorplanChatMessages     FloorplanChatMessage[]
  issues                    Issue[]                    @relation("IssueProject")
  client                    Client                     @relation(fields: [clientId], references: [id])
  createdBy                 User                       @relation("CreatedByUser", fields: [createdById], references: [id])
  organization              Organization               @relation(fields: [orgId], references: [id], onDelete: Cascade)
  updatedBy                 User?                      @relation("UpdatedByUser", fields: [updatedById], references: [id])
  projectContractors        ProjectContractor[]
  rooms                     Room[]
  roomSections              RoomSection[]
  specBooks                 SpecBook[]
  timeEntries               TimeEntry[]                @relation("ProjectTimeEntries")
  sources                   ProjectSource[]
  // RFQ system relations
  rfqs                      RFQ[]                      @relation("ProjectRFQs")
  clientQuotes              ClientQuote[]              @relation("ProjectClientQuotes")
  orders                    Order[]                    @relation("ProjectOrders")
  supplierMessages          SupplierMessage[]          @relation("ProjectSupplierMessages")
  shopDrawings              SupplierShopDrawing[]      @relation("ProjectShopDrawings")
  // Spec share links
  specShareLinks            SpecShareLink[]            @relation("ProjectSpecShareLinks")
  // Budget quotes
  budgetQuotes              BudgetQuote[]              @relation("BudgetQuoteProject")
  // Billing system
  proposals                 Proposal[]                 @relation("ProjectProposals")
  billingInvoices           BillingInvoice[]           @relation("ProjectBillingInvoices")
}

// Client Sources - files received from clients (measurements, architect plans, etc.)
model ProjectSource {
  id          String         @id @default(cuid())
  projectId   String
  category    SourceCategory
  title       String
  description String?
  dropboxPath String?
  dropboxUrl  String?
  fileName    String?
  fileSize    Int?
  mimeType    String?
  uploadedBy  String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  project        Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  uploadedByUser User    @relation("UploadedSourceFiles", fields: [uploadedBy], references: [id])

  @@index([projectId])
  @@index([category])
  @@index([projectId, category])
}

enum SourceCategory {
  EXISTING_MEASUREMENTS
  ARCHITECT_PLANS
  REFERENCE_IMAGES
  CLIENT_NOTES
  PROPOSALS
  CONTRACTS
  COMMUNICATION
  OTHER
}

model RoomSection {
  id        String   @id @default(cuid())
  projectId String
  name      String
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  rooms     Room[]
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([projectId, order])
}

model Room {
  id                 String              @id @default(cuid())
  projectId          String
  sectionId          String?
  type               RoomType
  name               String?
  order              Int                 @default(0)
  status             RoomStatus          @default(NOT_STARTED)
  currentStage       String?
  progressFFE        Int                 @default(0)
  startDate          DateTime?
  dueDate            DateTime?
  createdById        String?
  updatedById        String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  approvals          Approval[]
  assets             Asset[]             @relation("RoomAssets")
  comments           Comment[]
  ffeItems           FFEItem[]
  ffeItemStatuses    FFEItemStatus[]
  issues             Issue[]             @relation("IssueRoom")
  projectUpdateTasks ProjectUpdateTask[]
  renderingVersions  RenderingVersion[]  @relation("RoomRenderingVersions")
  createdBy          User?               @relation("CreatedByUserRoom", fields: [createdById], references: [id])
  project            Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  section            RoomSection?        @relation(fields: [sectionId], references: [id])
  updatedBy          User?               @relation("UpdatedByUserRoom", fields: [updatedById], references: [id])
  ffeInstance        RoomFFEInstance?    @relation("RoomFFEInstance")
  specBookSections   SpecBookSection[]
  stages             Stage[]
  timeEntries        TimeEntry[]         @relation("RoomTimeEntries")

  @@index([projectId])
  @@index([sectionId])
  @@index([projectId, order])
}

model Stage {
  id                     String                  @id @default(cuid())
  roomId                 String
  type                   StageType
  status                 StageStatus             @default(NOT_STARTED)
  assignedTo             String?
  startDate              DateTime?
  dueDate                DateTime?
  startedAt              DateTime?
  completedAt            DateTime?
  createdById            String?
  updatedById            String?
  completedById          String?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  assets                 Asset[]                 @relation("StageAssets")
  chatMessages           ChatMessage[]
  clientApprovalVersions ClientApprovalVersion[]
  comments               Comment[]
  designConceptItems     DesignConceptItem[]
  designSections         DesignSection[]
  issues                 Issue[]                 @relation("IssueStage")
  renderingVersions      RenderingVersion[]      @relation("StageRenderingVersions")
  smsConversations       SmsConversation[]       @relation("StageSmsConversations")
  assignedUser           User?                   @relation("AssignedToUser", fields: [assignedTo], references: [id])
  completedBy            User?                   @relation("CompletedByUserStage", fields: [completedById], references: [id])
  createdBy              User?                   @relation("CreatedByUserStage", fields: [createdById], references: [id])
  room                   Room                    @relation(fields: [roomId], references: [id], onDelete: Cascade)
  updatedBy              User?                   @relation("UpdatedByUserStage", fields: [updatedById], references: [id])
  timeEntries            TimeEntry[]             @relation("StageTimeEntries")

  @@unique([roomId, type])
}

model SmsConversation {
  id            String   @id @default(cuid())
  userId        String
  phoneNumber   String
  stageId       String
  lastMessageAt DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  stage         Stage    @relation("StageSmsConversations", fields: [stageId], references: [id], onDelete: Cascade)
  user          User     @relation("UserSmsConversations", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([phoneNumber])
  @@index([stageId])
  @@index([lastMessageAt])
  @@index([userId, stageId])
}

model DesignSection {
  id             String          @id @default(cuid())
  stageId        String
  type           String
  content        String?
  completed      Boolean         @default(false)
  createdById    String?
  updatedById    String?
  completedById  String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  assets         Asset[]         @relation("SectionAssets")
  checklistItems ChecklistItem[]
  comments       Comment[]
  completedBy    User?           @relation("CompletedByUserSection", fields: [completedById], references: [id])
  createdBy      User?           @relation("CreatedByUserSection", fields: [createdById], references: [id])
  stage          Stage           @relation(fields: [stageId], references: [id], onDelete: Cascade)
  updatedBy      User?           @relation("UpdatedByUserSection", fields: [updatedById], references: [id])

  @@unique([stageId, type])
}

model Tag {
  id           String       @id @default(cuid())
  name         String
  type         TagType      @default(CUSTOM)
  color        String?
  description  String?
  orgId        String
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  assetTags    AssetTag[]
  commentTags  CommentTag[]
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, name])
  @@index([orgId])
}

model AssetTag {
  id        String   @id @default(cuid())
  assetId   String
  tagId     String
  userId    String
  createdAt DateTime @default(now())
  asset     Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  user      User     @relation("UserAssetTags", fields: [userId], references: [id])

  @@unique([assetId, tagId])
  @@index([assetId])
  @@index([tagId])
}

model CommentTag {
  id        String   @id @default(cuid())
  commentId String
  tagId     String
  userId    String
  createdAt DateTime @default(now())
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  user      User     @relation("UserCommentTags", fields: [userId], references: [id])

  @@unique([commentId, tagId])
  @@index([commentId])
  @@index([tagId])
}

model AssetPin {
  id        String   @id @default(cuid())
  assetId   String   @unique
  userId    String
  createdAt DateTime @default(now())
  asset     Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  user      User     @relation("UserAssetPins", fields: [userId], references: [id])

  @@index([assetId])
}

model CommentPin {
  id        String   @id @default(cuid())
  commentId String   @unique
  userId    String
  createdAt DateTime @default(now())
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User     @relation("UserCommentPins", fields: [userId], references: [id])

  @@index([commentId])
}

model CommentLike {
  id        String   @id @default(cuid())
  commentId String
  userId    String
  createdAt DateTime @default(now())
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User     @relation("UserCommentLikes", fields: [userId], references: [id])

  @@unique([userId, commentId])
  @@index([commentId])
}

model ChecklistItem {
  id            String        @id @default(cuid())
  sectionId     String
  title         String
  description   String?
  completed     Boolean       @default(false)
  order         Int           @default(0)
  createdById   String
  completedById String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  completedAt   DateTime?
  completedBy   User?         @relation("ChecklistCompletedBy", fields: [completedById], references: [id])
  createdBy     User          @relation("ChecklistCreatedBy", fields: [createdById], references: [id])
  section       DesignSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@index([sectionId])
  @@index([order])
}

model FFEItem {
  id           String    @id @default(cuid())
  roomId       String
  name         String
  status       FFEStatus @default(NOT_STARTED)
  supplierLink String?
  notes        String?
  price        Float?
  leadTime     String?
  category     String?
  createdById  String?
  updatedById  String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  assets       Asset[]   @relation("FFEItemAssets")
  comments     Comment[]
  createdBy    User?     @relation("CreatedByUserFFE", fields: [createdById], references: [id])
  room         Room      @relation(fields: [roomId], references: [id], onDelete: Cascade)
  updatedBy    User?     @relation("UpdatedByUserFFE", fields: [updatedById], references: [id])
}

model FFEItemStatus {
  id               String    @id @default(cuid())
  roomId           String
  itemId           String
  state            String    @default("pending")
  selectionType    String?
  isCustomExpanded Boolean   @default(false)
  subItemStates    Json?     @default("{}")
  customOptions    Json?
  standardProduct  Json?
  notes            String?
  confirmedAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  createdById      String
  updatedById      String
  createdBy        User      @relation("FFEItemStatusCreatedBy", fields: [createdById], references: [id])
  room             Room      @relation(fields: [roomId], references: [id], onDelete: Cascade)
  updatedBy        User      @relation("FFEItemStatusUpdatedBy", fields: [updatedById], references: [id])

  @@unique([roomId, itemId])
  @@index([roomId])
  @@index([itemId])
  @@index([state])
  @@index([selectionType])
}

model ClientApprovalVersion {
  id                  String                    @id @default(cuid())
  stageId             String
  renderingVersionId  String?                   @unique
  version             String
  status              ClientApprovalStageStatus @default(DRAFT)
  approvedByAaron     Boolean                   @default(false)
  aaronApprovedAt     DateTime?
  aaronApprovedById   String?
  sentToClientAt      DateTime?
  sentById            String?
  emailOpenedAt       DateTime?
  followUpCompletedAt DateTime?
  followUpNotes       String?
  clientDecision      ApprovalStatus?           @default(PENDING)
  clientDecidedAt     DateTime?
  clientMessage       String?
  notes               String?
  followUpSentAt      DateTime?
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt
  activityLogs        ClientApprovalActivity[]
  assets              ClientApprovalAsset[]
  emailLogs           ClientApprovalEmailLog[]
  aaronApprovedBy     User?                     @relation("ClientApprovalAaronApprovedBy", fields: [aaronApprovedById], references: [id])
  renderingVersion    RenderingVersion?         @relation(fields: [renderingVersionId], references: [id])
  sentBy              User?                     @relation("ClientApprovalSentBy", fields: [sentById], references: [id])
  stage               Stage                     @relation(fields: [stageId], references: [id], onDelete: Cascade)
  emailLogsGeneric    EmailLog[]                @relation("EmailLogs")
}

model ClientApprovalAsset {
  id             String                @id @default(cuid())
  versionId      String
  assetId        String
  includeInEmail Boolean               @default(true)
  displayOrder   Int                   @default(0)
  blobUrl        String?
  createdAt      DateTime              @default(now())
  asset          Asset                 @relation(fields: [assetId], references: [id], onDelete: Cascade)
  version        ClientApprovalVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@unique([versionId, assetId])
}

model ClientApprovalEmailLog {
  id              String                @id @default(cuid())
  versionId       String
  to              String
  subject         String
  htmlContent     String
  sentAt          DateTime              @default(now())
  openedAt        DateTime?
  clickedAt       DateTime?
  followUpSentAt  DateTime?
  trackingPixelId String                @unique
  version         ClientApprovalVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)
}

model ClientApprovalActivity {
  id        String                @id @default(cuid())
  versionId String
  type      String
  message   String
  userId    String?
  metadata  String?
  createdAt DateTime              @default(now())
  user      User?                 @relation(fields: [userId], references: [id])
  version   ClientApprovalVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)
}

model FloorplanApprovalVersion {
  id                  String                      @id @default(cuid())
  projectId           String
  version             String
  status              FloorplanApprovalStatus     @default(DRAFT)
  approvedByAaron     Boolean                     @default(false)
  aaronApprovedAt     DateTime?
  aaronApprovedById   String?
  sentToClientAt      DateTime?
  sentById            String?
  emailOpenedAt       DateTime?
  followUpCompletedAt DateTime?
  followUpNotes       String?
  clientDecision      ApprovalStatus?             @default(PENDING)
  clientDecidedAt     DateTime?
  clientMessage       String?
  revisionItems       Json? // Array of {id, text, completed, completedAt}
  notes               String?
  followUpSentAt      DateTime?
  // TODO: Uncomment after running `prisma db push` on production
  // sourceFilePath      String?                     // Dropbox path to source CAD file
  // sourceFileName      String?                     // Name of the source file
  createdAt           DateTime                    @default(now())
  updatedAt           DateTime                    @updatedAt
  activityLogs        FloorplanApprovalActivity[]
  assets              FloorplanApprovalAsset[]
  emailLogs           FloorplanApprovalEmailLog[]
  aaronApprovedBy     User?                       @relation("FloorplanAaronApprovedBy", fields: [aaronApprovedById], references: [id])
  project             Project                     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sentBy              User?                       @relation("FloorplanSentBy", fields: [sentById], references: [id])

  @@unique([projectId, version])
  @@index([projectId])
  @@index([status])
  @@index([createdAt])
}

model FloorplanApprovalAsset {
  id             String                   @id @default(cuid())
  versionId      String
  assetId        String
  includeInEmail Boolean                  @default(true)
  displayOrder   Int                      @default(0)
  createdAt      DateTime                 @default(now())
  asset          Asset                    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  version        FloorplanApprovalVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@unique([versionId, assetId])
  @@index([versionId])
  @@index([assetId])
}

model FloorplanApprovalEmailLog {
  id              String                   @id @default(cuid())
  versionId       String
  to              String
  subject         String
  htmlContent     String
  sentAt          DateTime                 @default(now())
  openedAt        DateTime?
  clickedAt       DateTime?
  followUpSentAt  DateTime?
  trackingPixelId String                   @unique
  version         FloorplanApprovalVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@index([versionId])
  @@index([sentAt])
}

model FloorplanApprovalActivity {
  id        String                   @id @default(cuid())
  versionId String
  type      String
  message   String
  userId    String?
  metadata  String?
  createdAt DateTime                 @default(now())
  user      User?                    @relation(fields: [userId], references: [id])
  version   FloorplanApprovalVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@index([versionId])
  @@index([createdAt])
}

model Approval {
  id             String         @id @default(cuid())
  projectId      String?
  roomId         String?
  token          String         @unique @default(cuid())
  status         ApprovalStatus @default(PENDING)
  sentById       String?
  decidedById    String?
  sentAt         DateTime?
  decidedAt      DateTime?
  message        String?
  revisionReason String?
  expiresAt      DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  decidedBy      User?          @relation("DecidedByUser", fields: [decidedById], references: [id])
  project        Project?       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  room           Room?          @relation(fields: [roomId], references: [id], onDelete: Cascade)
  sentBy         User?          @relation("SentByUser", fields: [sentById], references: [id])
  assets         Asset[]
  comments       Comment[]
}

model Comment {
  id           String         @id @default(cuid())
  content      String
  authorId     String
  projectId    String?
  roomId       String?
  stageId      String?
  sectionId    String?
  ffeItemId    String?
  approvalId   String?
  mentions     String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  approval     Approval?      @relation(fields: [approvalId], references: [id], onDelete: Cascade)
  author       User           @relation(fields: [authorId], references: [id])
  ffeItem      FFEItem?       @relation(fields: [ffeItemId], references: [id], onDelete: Cascade)
  project      Project?       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  room         Room?          @relation(fields: [roomId], references: [id], onDelete: Cascade)
  section      DesignSection? @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  stage        Stage?         @relation(fields: [stageId], references: [id], onDelete: Cascade)
  commentLikes CommentLike[]
  commentPin   CommentPin?
  commentTags  CommentTag[]
}

model ChatMessage {
  id              String                @id @default(cuid())
  content         String
  authorId        String
  stageId         String?
  orgId           String?
  chatType        ChatType              @default(PHASE)
  parentMessageId String?
  imageUrl        String?
  imageFileName   String?
  attachments     Json?
  editedAt        DateTime?
  isEdited        Boolean               @default(false)
  deletedAt       DateTime?
  isDeleted       Boolean               @default(false)
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  mentions        ChatMention[]
  author          User                  @relation(fields: [authorId], references: [id])
  parentMessage   ChatMessage?          @relation("MessageReplies", fields: [parentMessageId], references: [id])
  replies         ChatMessage[]         @relation("MessageReplies")
  stage           Stage?                @relation(fields: [stageId], references: [id], onDelete: Cascade)
  org             Organization?         @relation("OrgChatMessages", fields: [orgId], references: [id])
  reactions       ChatMessageReaction[]

  @@index([stageId, createdAt])
  @@index([authorId])
  @@index([parentMessageId])
  @@index([orgId, chatType, createdAt])
}

model ChatMention {
  id            String      @id @default(cuid())
  messageId     String
  mentionedId   String
  createdAt     DateTime    @default(now())
  mentionedUser User        @relation(fields: [mentionedId], references: [id])
  message       ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, mentionedId])
}

model ChatMessageReaction {
  id        String      @id @default(cuid())
  messageId String
  userId    String
  emoji     String
  createdAt DateTime    @default(now())
  message   ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User        @relation("ChatMessageReactions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@index([userId])
}

model Asset {
  id                       String                    @id @default(cuid())
  title                    String
  filename                 String?
  url                      String
  type                     AssetType
  size                     Int?
  mimeType                 String?
  provider                 String?
  metadata                 String?
  description              String?
  userDescription          String?
  uploadedBy               String
  orgId                    String
  projectId                String?
  roomId                   String?
  stageId                  String?
  sectionId                String?
  ffeItemId                String?
  approvalId               String?
  commentId                String?
  renderingVersionId       String?
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  drawingChecklistItemId   String?
  approval                 Approval?                 @relation(fields: [approvalId], references: [id], onDelete: Cascade)
  drawingChecklistItem     DrawingChecklistItem?     @relation("DrawingChecklistAssets", fields: [drawingChecklistItemId], references: [id], onDelete: Cascade)
  ffeItem                  FFEItem?                  @relation("FFEItemAssets", fields: [ffeItemId], references: [id], onDelete: Cascade)
  project                  Project?                  @relation("ProjectAssets", fields: [projectId], references: [id], onDelete: Cascade)
  renderingVersion         RenderingVersion?         @relation("RenderingAssets", fields: [renderingVersionId], references: [id], onDelete: Cascade)
  room                     Room?                     @relation("RoomAssets", fields: [roomId], references: [id], onDelete: Cascade)
  section                  DesignSection?            @relation("SectionAssets", fields: [sectionId], references: [id], onDelete: Cascade)
  stage                    Stage?                    @relation("StageAssets", fields: [stageId], references: [id], onDelete: Cascade)
  uploadedByUser           User                      @relation("UploadedByUser", fields: [uploadedBy], references: [id])
  assetPin                 AssetPin?
  assetTags                AssetTag[]
  clientApprovalAssets     ClientApprovalAsset[]
  floorplanApprovalAssets  FloorplanApprovalAsset[]
  floorplanChatAttachments FloorplanChatAttachment[] @relation("FloorplanChatAssets")
}

model Notification {
  id          String           @id @default(cuid())
  userId      String
  type        NotificationType
  title       String
  message     String
  read        Boolean          @default(false)
  relatedId   String?
  relatedType String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model NotificationSend {
  id              String   @id @default(cuid())
  eventType       String
  stageId         String
  recipientUserId String
  actorUserId     String
  messageId       String?
  status          String   @default("SENT")
  errorMessage    String?
  customMessage   String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([eventType, stageId, recipientUserId])
  @@index([stageId])
  @@index([recipientUserId])
  @@index([eventType])
}

model RoomPreset {
  id          String   @id @default(cuid())
  roomType    RoomType
  name        String
  description String?
  ffeItems    String
  sections    String
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([roomType, name])
}

model Task {
  id          String     @id @default(cuid())
  title       String
  description String?
  status      TaskStatus @default(TODO)
  assignedTo  String?
  projectId   String?
  roomId      String?
  stageId     String?
  dueDate     DateTime?
  completedAt DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model UserSession {
  id        String   @id @default(cuid())
  userId    String
  deviceId  String
  ipAddress String?
  userAgent String?
  lastSeen  DateTime @updatedAt
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  @@unique([userId, deviceId])
}

model EmailLog {
  id             String                @id @default(cuid())
  versionId      String
  to             String
  subject        String
  html           String
  sentAt         DateTime              @default(now())
  openedAt       DateTime?
  type           String
  metadata       Json?
  deliveryStatus String?               @default("PENDING")
  deliveryError  String?
  providerId     String?
  provider       String?
  deliveredAt    DateTime?
  version        ClientApprovalVersion @relation("EmailLogs", fields: [versionId], references: [id], onDelete: Cascade)
}

model ClientApproval {
  id         String   @id @default(cuid())
  versionId  String
  approvedBy String
  approvedAt DateTime @default(now())
  decision   String
  comments   String?
}

model Activity {
  id        String   @id @default(cuid())
  stageId   String
  type      String
  message   String
  userId    String?
  timestamp DateTime @default(now())
  user      User?    @relation("ActivityUser", fields: [userId], references: [id])
}

model RenderingVersion {
  id                    String                 @id @default(cuid())
  roomId                String
  stageId               String
  version               String
  customName            String?
  status                RenderingVersionStatus @default(IN_PROGRESS)
  pushedToClientAt      DateTime?
  sourceFilePath        String? // Dropbox path to source Max file
  sourceFileName        String? // Name of the source file
  createdById           String
  updatedById           String?
  completedById         String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  completedAt           DateTime?
  assets                Asset[]                @relation("RenderingAssets")
  clientApprovalVersion ClientApprovalVersion?
  notes                 RenderingNote[]
  completedBy           User?                  @relation("RenderingVersionCompletedBy", fields: [completedById], references: [id])
  createdBy             User                   @relation("RenderingVersionCreatedBy", fields: [createdById], references: [id])
  room                  Room                   @relation("RoomRenderingVersions", fields: [roomId], references: [id], onDelete: Cascade)
  stage                 Stage                  @relation("StageRenderingVersions", fields: [stageId], references: [id], onDelete: Cascade)
  updatedBy             User?                  @relation("RenderingVersionUpdatedBy", fields: [updatedById], references: [id])

  @@unique([roomId, version])
  @@index([stageId])
  @@index([createdAt])
}

model RenderingNote {
  id        String           @id @default(cuid())
  versionId String
  content   String
  authorId  String
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  author    User             @relation("RenderingNoteAuthor", fields: [authorId], references: [id])
  version   RenderingVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@index([versionId])
  @@index([createdAt])
}

model DrawingChecklistItem {
  id           String               @id @default(cuid())
  stageId      String
  type         DrawingChecklistType
  name         String
  description  String?
  completed    Boolean              @default(false)
  order        Int                  @default(0)
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  completedAt  DateTime?
  assets       Asset[]              @relation("DrawingChecklistAssets")
  dropboxFiles DropboxFileLink[]    @relation("DrawingChecklistDropboxFiles")

  @@index([stageId])
  @@index([order])
}

model ActivityLog {
  id        String   @id @default(cuid())
  actorId   String?
  action    String
  entity    String
  entityId  String
  details   Json?
  ipAddress String?
  orgId     String?
  createdAt DateTime @default(now())
  actor     User?    @relation("ActivityLogActor", fields: [actorId], references: [id])

  @@index([actorId])
  @@index([orgId])
  @@index([entity, entityId])
  @@index([createdAt])
}

model ClientAccessToken {
  id             String            @id @default(cuid())
  projectId      String
  token          String            @unique @default(cuid())
  name           String?
  specsUrl       String?
  active         Boolean           @default(true)
  expiresAt      DateTime?
  createdById    String
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  lastAccessedAt DateTime?
  accessCount    Int               @default(0)
  lastAccessedIP String?
  accessLogs     ClientAccessLog[]
  createdBy      User              @relation("ClientAccessTokenCreatedBy", fields: [createdById], references: [id])
  project        Project           @relation("ClientAccessTokenProject", fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([token])
  @@index([active])
  @@index([expiresAt])
}

model ClientAccessLog {
  id        String            @id @default(cuid())
  tokenId   String
  ipAddress String?
  userAgent String?
  action    String
  metadata  Json?
  createdAt DateTime          @default(now())
  token     ClientAccessToken @relation(fields: [tokenId], references: [id], onDelete: Cascade)

  @@index([tokenId])
  @@index([createdAt])
  @@index([action])
}

model PhaseAccessToken {
  id             String    @id @default(cuid())
  stageId        String
  token          String    @unique @default(cuid())
  name           String?
  active         Boolean   @default(true)
  expiresAt      DateTime?
  createdById    String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  lastAccessedAt DateTime?
  accessCount    Int       @default(0)
  lastAccessedIP String?

  @@index([stageId])
  @@index([token])
  @@index([active])
  @@index([expiresAt])
}

model PhaseAccessLog {
  id        String   @id @default(cuid())
  tokenId   String
  ipAddress String?
  userAgent String?
  action    String
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([tokenId])
  @@index([createdAt])
  @@index([action])
}

model Issue {
  id          String         @id @default(cuid())
  title       String
  description String
  type        IssueType      @default(GENERAL)
  priority    IssuePriority  @default(MEDIUM)
  status      IssueStatus    @default(OPEN)
  reportedBy  String
  assignedTo  String?
  resolvedBy  String?
  orgId       String?
  projectId   String?
  roomId      String?
  stageId     String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  resolvedAt  DateTime?
  closedAt    DateTime?
  metadata    Json?
  assignee    User?          @relation("IssueAssignee", fields: [assignedTo], references: [id])
  project     Project?       @relation("IssueProject", fields: [projectId], references: [id], onDelete: Cascade)
  reporter    User           @relation("IssueReporter", fields: [reportedBy], references: [id])
  resolver    User?          @relation("IssueResolver", fields: [resolvedBy], references: [id])
  room        Room?          @relation("IssueRoom", fields: [roomId], references: [id], onDelete: Cascade)
  stage       Stage?         @relation("IssueStage", fields: [stageId], references: [id], onDelete: Cascade)
  comments    IssueComment[]

  @@index([reportedBy])
  @@index([assignedTo])
  @@index([status])
  @@index([createdAt])
  @@index([orgId])
  @@index([projectId])
  @@index([roomId])
}

model IssueComment {
  id        String   @id @default(cuid())
  issueId   String
  content   String
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  author    User     @relation("IssueCommentAuthor", fields: [authorId], references: [id])
  issue     Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@index([issueId])
  @@index([createdAt])
}

model FFELibraryItem {
  id                 String   @id @default(cuid())
  orgId              String
  itemId             String
  name               String
  category           String
  roomTypes          String[]
  isRequired         Boolean  @default(false)
  itemType           String   @default("base")
  hasStandardOption  Boolean  @default(false)
  hasCustomOption    Boolean  @default(false)
  standardConfig     Json?
  customConfig       Json?
  dependsOn          String[]
  showWhen           Json?
  isStandard         Boolean  @default(true)
  subItems           Json?
  notes              String?
  addedFromProjectId String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  createdById        String
  updatedById        String

  @@unique([orgId, itemId])
  @@index([orgId])
  @@index([category])
  @@index([roomTypes], type: Gin)
  @@index([itemType])
}

model FFEGeneralSettings {
  id          String   @id @default(cuid())
  orgId       String   @unique
  roomType    String
  settings    Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String
  updatedById String

  @@unique([orgId, roomType])
  @@index([orgId])
  @@index([roomType])
}

model FFEAuditLog {
  id        String   @id @default(cuid())
  roomId    String
  itemId    String
  action    String
  oldValue  String?
  newValue  String?
  notes     String?
  userId    String
  createdAt DateTime @default(now())

  @@index([roomId])
  @@index([itemId])
  @@index([userId])
  @@index([createdAt])
}

model FFEBathroomState {
  id                   String   @id @default(cuid())
  roomId               String   @unique
  categorySelections   String   @default("[]")
  itemStatuses         String   @default("[]")
  completionPercentage Float    @default(0)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  createdById          String
  updatedById          String

  @@index([roomId])
  @@index([completionPercentage])
}

model FFETemplate {
  id          String               @id @default(cuid())
  orgId       String
  name        String
  description String?
  status      FFETemplateStatus    @default(DRAFT)
  isDefault   Boolean              @default(false)
  version     Int                  @default(1)
  tags        String[]
  metadata    Json?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  createdById String
  updatedById String
  createdBy   User                 @relation("FFETemplateCreatedBy", fields: [createdById], references: [id])
  updatedBy   User                 @relation("FFETemplateUpdatedBy", fields: [updatedById], references: [id])
  sections    FFETemplateSection[] @relation("TemplateToSections")
  instances   RoomFFEInstance[]    @relation("RoomFFEInstanceTemplate")

  @@unique([orgId, name], name: "unique_template_per_org")
  @@index([orgId])
  @@index([status])
}

model FFETemplateSection {
  id            String            @id @default(cuid())
  templateId    String
  name          String
  description   String?
  order         Int               @default(0)
  isRequired    Boolean           @default(false)
  isCollapsible Boolean           @default(true)
  icon          String?
  color         String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  items         FFETemplateItem[] @relation("SectionToItems")
  template      FFETemplate       @relation("TemplateToSections", fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId, order])
}

model FFETemplateItem {
  id            String             @id @default(cuid())
  sectionId     String
  name          String
  description   String?
  defaultState  FFEItemState       @default(PENDING)
  isRequired    Boolean            @default(false)
  order         Int                @default(0)
  category      String?
  tags          String[]
  estimatedCost Decimal?
  leadTimeWeeks Int?
  supplierInfo  Json?
  customFields  Json?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  section       FFETemplateSection @relation("SectionToItems", fields: [sectionId], references: [id], onDelete: Cascade)
  roomItems     RoomFFEItem[]      @relation("RoomFFEItemTemplate")

  @@index([sectionId, order])
  @@index([isRequired])
}

model RoomFFEInstance {
  id                   String            @id @default(cuid())
  roomId               String            @unique
  templateId           String?
  name                 String
  status               FFEInstanceStatus @default(NOT_STARTED)
  progress             Decimal           @default(0)
  estimatedBudget      Decimal?
  actualBudget         Decimal?
  targetCompletionDate DateTime?
  actualCompletionDate DateTime?
  notes                String?
  metadata             Json?
  programaLink         String? // Link to Programa.design schedule for this room's FFE items
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  createdById          String
  updatedById          String
  createdBy            User              @relation("RoomFFEInstanceCreatedBy", fields: [createdById], references: [id])
  room                 Room              @relation("RoomFFEInstance", fields: [roomId], references: [id], onDelete: Cascade)
  template             FFETemplate?      @relation("RoomFFEInstanceTemplate", fields: [templateId], references: [id])
  updatedBy            User              @relation("RoomFFEInstanceUpdatedBy", fields: [updatedById], references: [id])
  sections             RoomFFESection[]  @relation("RoomFFEInstanceSections")

  @@index([roomId])
  @@index([templateId])
  @@index([status])
}

model RoomFFESection {
  id                String            @id @default(cuid())
  instanceId        String
  templateSectionId String?
  presetId          String? // Link to FFESectionPreset
  name              String
  description       String?
  docCodePrefix     String? // Doc code prefix for items (e.g., "PL" for Plumbing)
  order             Int               @default(0)
  isExpanded        Boolean           @default(true)
  isCompleted       Boolean           @default(false)
  completedAt       DateTime?
  notes             String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  items             RoomFFEItem[]     @relation("RoomFFESectionItems")
  instance          RoomFFEInstance   @relation("RoomFFEInstanceSections", fields: [instanceId], references: [id], onDelete: Cascade)
  preset            FFESectionPreset? @relation(fields: [presetId], references: [id])

  @@index([instanceId, order])
  @@index([presetId])
}

// Section presets with doc code prefixes (configured per organization)
model FFESectionPreset {
  id            String   @id @default(cuid())
  orgId         String
  name          String // e.g., "Plumbing"
  docCodePrefix String // e.g., "PL" (1-3 uppercase letters)
  description   String?
  order         Int      @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  sections RoomFFESection[]

  @@unique([orgId, name])
  @@unique([orgId, docCodePrefix])
  @@index([orgId])
}

model RoomFFEItem {
  id                 String            @id @default(cuid())
  sectionId          String
  templateItemId     String?
  libraryProductId   String? // Link to Product Library
  name               String
  description        String?
  state              FFEItemState      @default(PENDING)
  visibility         FFEItemVisibility @default(HIDDEN)
  specStatus         FFESpecStatus     @default(DRAFT)
  clientApproved     Boolean           @default(false) // Client approval flag for ordering
  clientApprovedAt   DateTime? // When client approved this item
  clientApprovedVia  String? // How approved: "share_link", "portal", etc.
  isRequired         Boolean           @default(false)
  isCustom           Boolean           @default(false)
  order              Int               @default(0)
  quantity           Int               @default(1)
  unitType           String?           @default("units") // Unit type: units, SF, SY, LF, etc.
  unitCost           Decimal?
  totalCost          Decimal?
  tradePrice         Decimal?
  rrp                Decimal?
  tradeDiscount      Decimal? // Percentage discount
  markupPercent      Decimal? // Markup percentage for client pricing (from supplier default, can override)
  currency           String?           @default("CAD") // Currency: CAD or USD (legacy)
  rrpCurrency        String?           @default("CAD") // RRP currency: CAD or USD
  tradePriceCurrency String?           @default("CAD") // Trade price currency: CAD or USD
  supplierName       String?
  supplierLink       String?
  supplierId         String? // Link to Supplier from phonebook
  modelNumber        String?

  // === PROCUREMENT TRACKING ===
  // Tracks which quote was accepted for this item (when multiple quotes exist)
  acceptedQuoteLineItemId String?           @unique // The SupplierQuoteLineItem that was accepted
  // Payment tracking at item level
  paymentStatus           ItemPaymentStatus @default(NOT_INVOICED)
  paidAmount              Decimal? // Total amount paid for this item
  paidAt                  DateTime? // When last payment was received

  // Additional spec fields
  brand         String?
  sku           String?
  docCode       String? // Document code (separate from SKU)
  color         String?
  finish        String?
  material      String?
  leadTime      String?
  width         String?
  height        String?
  depth         String?
  length        String?
  images        String[]
  notes         String?
  completedAt   DateTime?
  completedById String?
  attachments   Json?
  customFields  Json?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdById   String
  updatedById   String

  // NEW: FFE Workspace <-> All Specs linking
  // For FFE Workspace items (requirements): ffeRequirementId is null, isSpecItem is false
  // For All Specs items (products): ffeRequirementId points to the requirement, isSpecItem is true
  ffeRequirementId String? // Links spec item back to its FFE requirement
  isSpecItem       Boolean @default(false) // True if this is an actual product spec
  isOption         Boolean @default(false) // True if this is an option (multiple products for same FFE item)
  optionNumber     Int? // Option number (1, 2, 3, etc.) when multiple options exist

  // Relations
  section        RoomFFESection      @relation("RoomFFESectionItems", fields: [sectionId], references: [id], onDelete: Cascade)
  templateItem   FFETemplateItem?    @relation("RoomFFEItemTemplate", fields: [templateItemId], references: [id])
  libraryProduct ProductLibraryItem? @relation("RoomItemToLibraryProduct", fields: [libraryProductId], references: [id])
  supplier       Supplier?           @relation("SupplierFFEItems", fields: [supplierId], references: [id])
  createdBy      User                @relation("RoomFFEItemCreatedBy", fields: [createdById], references: [id])
  updatedBy      User                @relation("RoomFFEItemUpdatedBy", fields: [updatedById], references: [id])

  // Self-relation for FFE requirement <-> Spec items (legacy one-to-one)
  ffeRequirement RoomFFEItem?  @relation("FFERequirementSpecs", fields: [ffeRequirementId], references: [id], onDelete: SetNull)
  linkedSpecs    RoomFFEItem[] @relation("FFERequirementSpecs")

  // Many-to-many relations for FFE items <-> Spec items via FFESpecLink
  specLinks FFESpecLink[] @relation("SpecItemLinks") // When this is a spec item: links to FFE requirements
  ffeLinks  FFESpecLink[] @relation("FFERequirementLinks") // When this is an FFE requirement: links from spec items

  // RFQ system relations
  rfqLineItems         RFQLineItem[]         @relation("RFQLineItems")
  clientQuoteLineItems ClientQuoteLineItem[] @relation("ClientQuoteLineItems")
  orderItems           OrderItem[]           @relation("OrderItems")

  // Procurement quote tracking
  acceptedQuoteLineItem SupplierQuoteLineItem?  @relation("AcceptedQuoteForItem", fields: [acceptedQuoteLineItemId], references: [id])
  allQuoteLineItems     SupplierQuoteLineItem[] @relation("ItemQuoteLineItems") // All quotes for this item

  // Documents directly attached to this item
  documents RFQDocument[] @relation("SpecItemDocuments")

  // Activity tracking for item
  quoteRequests ItemQuoteRequest[] @relation("ItemQuoteRequests")
  activities    ItemActivity[]     @relation("ItemActivities")

  // Programa import links
  programaLinks ProgramaItem[] @relation("ProgramaLinkedItem")

  // Item components (sub-items like transformer for a light fixture)
  components ItemComponent[] @relation("ItemComponents")

  @@index([sectionId, order])
  @@index([state])
  @@index([visibility])
  @@index([specStatus])
  @@index([sectionId, visibility])
  @@index([isRequired])
  @@index([libraryProductId])
  @@index([ffeRequirementId])
  @@index([isSpecItem])
  @@index([supplierId])
  @@index([paymentStatus])
  @@index([acceptedQuoteLineItemId])
}

// Item components - sub-items that belong to a parent spec item
// Example: LED fixture ($100) + transformer ($50) + mounting bracket ($25)
// The main item shows "LED Fixture" but total price includes all components
model ItemComponent {
  id          String   @id @default(cuid())
  itemId      String // Parent RoomFFEItem
  name        String // Component name (e.g., "Transformer")
  modelNumber String? // Component model number
  image       String? // Component image URL
  link        String? // Product link URL
  price       Decimal? // Component price (uses parent's currency)
  quantity    Int      @default(1)
  order       Int      @default(0)
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // === COMPONENT QUOTE TRACKING ===
  // Components can have their own quotes (e.g., transformer from different supplier)
  quotedPrice             Decimal? // Price from the accepted quote
  quotedAt                DateTime? // When this component was quoted
  acceptedQuoteLineItemId String? // Links to the quote line item for this component

  // Relation to parent item
  item RoomFFEItem @relation("ItemComponents", fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@index([itemId, order])
}

// Tracks quote requests sent for a specific item to a specific supplier
// Prevents duplicate sends and tracks status
model ItemQuoteRequest {
  id            String  @id @default(cuid())
  itemId        String // RoomFFEItem id
  supplierId    String? // Supplier id (null for one-time vendors)
  rfqId         String? // RFQ id if sent via RFQ
  supplierRfqId String? // SupplierRFQ id for tracking

  // One-time vendor info
  vendorEmail String?
  vendorName  String?

  // Status tracking
  status   QuoteRequestStatus @default(SENT)
  sentAt   DateTime           @default(now())
  sentById String

  // Response tracking
  respondedAt DateTime?
  quoteAmount Decimal? // Quote amount if provided
  quoteId     String? // SupplierQuote id if quote received

  // Override tracking
  isResend          Boolean @default(false)
  previousRequestId String? // Links to previous request if resent

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  item     RoomFFEItem @relation("ItemQuoteRequests", fields: [itemId], references: [id], onDelete: Cascade)
  supplier Supplier?   @relation("SupplierQuoteRequests", fields: [supplierId], references: [id])
  rfq      RFQ?        @relation("RFQQuoteRequests", fields: [rfqId], references: [id])
  sentBy   User        @relation("QuoteRequestSentBy", fields: [sentById], references: [id])

  @@unique([itemId, supplierId, isResend]) // One active request per item-supplier unless resent
  @@index([itemId])
  @@index([supplierId])
  @@index([rfqId])
  @@index([status])
  @@index([sentAt])
}

enum QuoteRequestStatus {
  SENT
  VIEWED
  QUOTED
  DECLINED
  EXPIRED
}

// Tracks all activity related to an item (quotes, status changes, client responses, etc.)
model ItemActivity {
  id          String           @id @default(cuid())
  itemId      String
  type        ItemActivityType
  title       String // Short title (e.g., "Quote Requested")
  description String? // Detailed description
  metadata    Json? // Additional data (supplier info, quote amount, etc.)

  // Actor tracking
  actorId   String? // User who performed the action (null for system/supplier actions)
  actorName String? // Name for display (supplier name, client name, etc.)
  actorType String  @default("user") // "user", "supplier", "client", "system"

  createdAt DateTime @default(now())

  // Relations
  item  RoomFFEItem @relation("ItemActivities", fields: [itemId], references: [id], onDelete: Cascade)
  actor User?       @relation("ItemActivityActor", fields: [actorId], references: [id])

  @@index([itemId])
  @@index([itemId, createdAt])
  @@index([type])
}

enum ItemActivityType {
  QUOTE_REQUESTED // Quote request sent to supplier
  QUOTE_RECEIVED // Supplier submitted a quote
  QUOTE_ACCEPTED // Quote was accepted for this item
  QUOTE_DECLINED // Supplier declined to quote
  QUOTE_VIEWED // Supplier viewed the request
  STATUS_CHANGED // Item status changed
  ITEM_SELECTED // Item selected for project
  PRICE_UPDATED // Price was updated
  CLIENT_APPROVED // Client approved the item
  CLIENT_UNAPPROVED // Client approval was removed
  CLIENT_REJECTED // Client requested changes
  ADDED_TO_ORDER // Item added to purchase order
  ORDERED // Item ordered from supplier
  SHIPPED // Item shipped
  DELIVERED // Item delivered
  NOTE_ADDED // Note added to item
  DOCUMENT_UPLOADED // Document attached
  SENT_TO_CLIENT_QUOTE // Item sent to client via quote
  CLIENT_QUOTE_VIEWED // Client viewed the quote
  CLIENT_QUOTE_PAID // Client paid for item via quote
}

model FFEChangeLog {
  id         String   @id @default(cuid())
  entityType String
  entityId   String
  action     String
  fieldName  String?
  oldValue   String?
  newValue   String?
  userId     String
  orgId      String
  roomId     String?
  instanceId String?
  metadata   Json?
  createdAt  DateTime @default(now())

  @@index([entityType, entityId])
  @@index([userId, createdAt])
  @@index([orgId, createdAt])
}

// Many-to-many join table: Links FFE requirements to spec items (products)
// One product in AllSpec can be linked to multiple FFE requirements from different rooms
model FFESpecLink {
  id               String   @id @default(cuid())
  specItemId       String // The product in AllSpec
  ffeRequirementId String // The FFE requirement from FFE Workspace
  roomId           String // Room where the FFE requirement is from (for display)
  roomName         String? // Room name (denormalized for quick display)
  sectionName      String? // Section name (denormalized for quick display)
  createdAt        DateTime @default(now())
  createdById      String

  specItem       RoomFFEItem @relation("SpecItemLinks", fields: [specItemId], references: [id], onDelete: Cascade)
  ffeRequirement RoomFFEItem @relation("FFERequirementLinks", fields: [ffeRequirementId], references: [id], onDelete: Cascade)
  createdBy      User        @relation("FFESpecLinkCreatedBy", fields: [createdById], references: [id])

  @@unique([specItemId, ffeRequirementId])
  @@index([specItemId])
  @@index([ffeRequirementId])
  @@index([roomId])
}

model FFESectionLibrary {
  id                  String     @id @default(cuid())
  name                String     @unique
  description         String?
  icon                String?
  color               String?
  defaultOrder        Int        @default(0)
  applicableRoomTypes RoomType[]
  isGlobal            Boolean    @default(true)
  createdAt           DateTime   @default(now())
}

// ============================================
// PRODUCT LIBRARY SYSTEM
// ============================================

model ProductCategory {
  id          String               @id @default(cuid())
  orgId       String? // null = global/default category
  name        String
  slug        String
  description String?
  icon        String? // Lucide icon name
  color       String? // Hex color for UI
  parentId    String? // For subcategories
  order       Int                  @default(0)
  isDefault   Boolean              @default(false) // Pre-seeded categories
  isActive    Boolean              @default(true)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  parent      ProductCategory?     @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    ProductCategory[]    @relation("CategoryHierarchy")
  products    ProductLibraryItem[] @relation("ProductToCategory")

  @@unique([orgId, slug])
  @@index([orgId])
  @@index([parentId])
  @@index([isActive])
  @@index([order])
}

model SupplierCategory {
  id        String   @id @default(cuid())
  orgId     String
  name      String // Category name (e.g. "Plumbing", "Lighting")
  icon      String? // Icon name (optional, e.g. "Wrench", "Lightbulb")
  color     String? // Color code (optional, e.g. "blue", "amber")
  isDefault Boolean  @default(false) // System default categories
  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  suppliers Supplier[]

  @@unique([orgId, name])
  @@index([orgId])
  @@index([orgId, isActive])
}

model Supplier {
  id            String   @id @default(cuid())
  orgId         String
  name          String // Business name (required)
  contactName   String // Contact person name (required)
  email         String // Primary contact email (required)
  emails        Json? // Additional emails as array: ["email1@example.com", "email2@example.com"]
  category      String? // Legacy category field (deprecated)
  categoryId    String? // Reference to SupplierCategory
  currency      String   @default("CAD") // Currency for prices: CAD or USD
  logo          String? // Logo URL (optional)
  phone         String? // Phone (optional)
  address       String? // Address (optional)
  website       String? // Website (optional)
  notes         String? // Notes (optional)
  markupPercent Decimal? // Fixed markup percentage for this supplier (overrides category markup)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdById   String

  // Portal access fields
  hasPortalAccess Boolean   @default(false)
  portalPassword  String? // Hashed password for portal login
  portalLastLogin DateTime?
  portalEnabled   Boolean   @default(true)

  // Relations
  supplierCategory SupplierCategory?     @relation(fields: [categoryId], references: [id])
  supplierRFQs     SupplierRFQ[]
  orders           Order[]
  messages         SupplierMessage[]
  shopDrawings     SupplierShopDrawing[]
  quoteRequests    ItemQuoteRequest[]    @relation("SupplierQuoteRequests")
  ffeItems         RoomFFEItem[]         @relation("SupplierFFEItems")

  @@index([orgId])
  @@index([orgId, isActive])
  @@index([email])
  @@index([category])
  @@index([categoryId])
}

model ProductLibraryItem {
  id              String               @id @default(cuid())
  orgId           String
  categoryId      String?
  name            String
  description     String?
  brand           String?
  sku             String?
  modelNumber     String?
  // Specifications
  color           String?
  finish          String?
  material        String?
  // Dimensions
  width           String?
  height          String?
  depth           String?
  length          String?
  dimensionUnit   String?              @default("cm")
  // Pricing
  rrp             Decimal?
  tradePrice      Decimal?
  currency        String?              @default("USD")
  // Supplier info
  supplierName    String?
  supplierPhone   String?
  supplierEmail   String?
  supplierAddress String?
  supplierLink    String?
  leadTime        String?
  isTaxable       Boolean?             @default(true)
  // Media
  images          String[] // Array of image URLs
  thumbnailUrl    String? // Primary image for display
  attachments     Json? // PDFs, spec sheets, etc.
  // Metadata
  tags            String[]
  customFields    Json?
  notes           String?
  status          ProductLibraryStatus @default(ACTIVE)
  // Tracking
  usageCount      Int                  @default(0) // How many times added to rooms
  lastUsedAt      DateTime?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  createdById     String
  updatedById     String
  // Relations
  category        ProductCategory?     @relation("ProductToCategory", fields: [categoryId], references: [id])
  roomItems       RoomFFEItem[]        @relation("RoomItemToLibraryProduct")

  @@index([orgId])
  @@index([categoryId])
  @@index([status])
  @@index([orgId, categoryId])
  @@index([orgId, status])
  @@index([brand])
  @@index([createdAt])
}

model ProjectUpdate {
  id             String                @id @default(cuid())
  projectId      String
  roomId         String?
  authorId       String
  type           ProjectUpdateType     @default(GENERAL)
  category       ProjectUpdateCategory @default(GENERAL)
  status         ProjectUpdateStatus   @default(ACTIVE)
  priority       PriorityLevel         @default(MEDIUM)
  title          String?
  description    String?
  location       String?
  gpsCoordinates Json?
  metadata       Json?
  dueDate        DateTime?
  completedAt    DateTime?
  completedById  String?
  estimatedCost  Decimal?
  actualCost     Decimal?
  timeEstimated  Int?
  timeLogged     Int?
  parentUpdateId String?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  tasks          ProjectUpdateTask[]

  @@index([projectId, createdAt])
  @@index([roomId])
  @@index([status])
  @@index([priority])
}

model ProjectUpdatePhoto {
  id                String    @id @default(cuid())
  updateId          String
  assetId           String
  caption           String?
  gpsCoordinates    Json?
  takenAt           DateTime?
  beforeAfterPairId String?   @unique
  tags              String[]
  roomArea          String?
  tradeCategory     String?
  isBeforePhoto     Boolean   @default(false)
  isAfterPhoto      Boolean   @default(false)
  annotationsData   Json?
  aiAnalysis        Json?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([updateId])
  @@index([takenAt])
  @@index([tradeCategory])
}

model ProjectUpdateTask {
  id             String                 @id @default(cuid())
  updateId       String?
  projectId      String
  roomId         String?
  title          String
  description    String?
  status         TaskStatus             @default(TODO)
  priority       PriorityLevel          @default(MEDIUM)
  assigneeId     String?
  contractorId   String?
  tradeType      String?
  estimatedHours Decimal?
  actualHours    Decimal?
  estimatedCost  Decimal?
  actualCost     Decimal?
  materials      Json?
  dependencies   String[]
  dueDate        DateTime?
  startedAt      DateTime?
  completedAt    DateTime?
  createdById    String
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  assignments    ContractorAssignment[]
  messages       ProjectUpdateMessage[]
  assignee       User?                  @relation("TaskAssignee", fields: [assigneeId], references: [id])
  contractor     Contractor?            @relation(fields: [contractorId], references: [id])
  createdBy      User                   @relation("TaskCreatedBy", fields: [createdById], references: [id])
  room           Room?                  @relation(fields: [roomId], references: [id])
  update         ProjectUpdate?         @relation(fields: [updateId], references: [id])

  @@index([projectId, status])
  @@index([assigneeId])
  @@index([contractorId])
  @@index([dueDate])
}

model ProjectUpdateDocument {
  id                  String         @id @default(cuid())
  updateId            String
  assetId             String
  documentType        DocumentType   @default(OTHER)
  version             String
  isCurrentVersion    Boolean        @default(true)
  changesFromPrevious String?
  approvalStatus      ApprovalStatus @default(PENDING)
  approvedById        String?
  approvedAt          DateTime?
  expiresAt           DateTime?
  distributionList    Json?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  @@index([updateId])
  @@index([documentType])
  @@index([approvalStatus])
}

model ProjectUpdateMessage {
  id              String             @id @default(cuid())
  updateId        String
  taskId          String?
  authorId        String
  content         String
  messageType     MessageType        @default(MESSAGE)
  priority        PriorityLevel      @default(NORMAL)
  parentMessageId String?
  mentions        String[]
  attachments     Json?
  readBy          Json?
  reactions       Json?
  isUrgent        Boolean            @default(false)
  scheduledFor    DateTime?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  deletedAt       DateTime?
  task            ProjectUpdateTask? @relation(fields: [taskId], references: [id])

  @@index([updateId, createdAt])
  @@index([taskId])
  @@index([authorId])
}

model ProjectUpdateActivity {
  id          String   @id @default(cuid())
  updateId    String?
  projectId   String
  actorId     String?
  actionType  String
  entityType  String
  entityId    String
  description String
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([projectId, createdAt])
  @@index([entityType, entityId])
}

model ContractorAssignment {
  id                 String             @id @default(cuid())
  projectId          String
  contractorId       String
  updateId           String?
  taskId             String?
  role               String
  status             AssignmentStatus   @default(ASSIGNED)
  notificationMethod NotificationMethod @default(EMAIL)
  lastNotifiedAt     DateTime?
  acknowledgedAt     DateTime?
  completedAt        DateTime?
  notes              String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  task               ProjectUpdateTask? @relation(fields: [taskId], references: [id])

  @@index([projectId])
  @@index([contractorId])
  @@index([status])
}

model ProjectMilestone {
  id                  String          @id @default(cuid())
  projectId           String
  updateId            String?
  name                String
  description         String?
  type                MilestoneType   @default(CUSTOM)
  status              MilestoneStatus @default(PENDING)
  percentage          Decimal         @default(0)
  targetDate          DateTime?
  actualDate          DateTime?
  dependencies        String[]
  celebrateWithClient Boolean         @default(false)
  autoGenerateReport  Boolean         @default(true)
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  @@index([projectId])
  @@index([status])
}

model SpecBook {
  id          String               @id @default(cuid())
  projectId   String
  name        String
  description String?
  isActive    Boolean              @default(true)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  createdById String
  updatedById String
  project     Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)
  generations SpecBookGeneration[] @relation("SpecBookGenerations")
  sections    SpecBookSection[]

  @@index([projectId])
  @@index([isActive])
}

model SpecBookSection {
  id            String              @id @default(cuid())
  specBookId    String
  type          SpecBookSectionType
  name          String
  description   String?
  roomId        String?
  order         Int                 @default(0)
  isIncluded    Boolean             @default(true)
  renderingUrl  String?
  renderingUrls String[]            @default([])
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  dropboxFiles  DropboxFileLink[]
  room          Room?               @relation(fields: [roomId], references: [id], onDelete: Cascade)
  specBook      SpecBook            @relation(fields: [specBookId], references: [id], onDelete: Cascade)

  @@unique([specBookId, type, roomId])
  @@index([specBookId, order])
  @@index([type])
  @@index([roomId])
}

model DropboxFileLink {
  id                     String                @id @default(cuid())
  sectionId              String?
  drawingChecklistItemId String?
  dropboxPath            String
  dropboxFileId          String?
  fileName               String
  fileSize               Int?
  lastModified           DateTime?
  dropboxRevision        String?
  cadToPdfCacheUrl       String?
  uploadedPdfUrl         String?
  cacheExpiry            DateTime?
  isActive               Boolean               @default(true)
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  drawingChecklistItem   DrawingChecklistItem? @relation("DrawingChecklistDropboxFiles", fields: [drawingChecklistItemId], references: [id], onDelete: Cascade)
  section                SpecBookSection?      @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@index([sectionId])
  @@index([drawingChecklistItemId])
  @@index([dropboxPath])
  @@index([dropboxRevision])
}

model SpecBookGeneration {
  id               String            @id @default(cuid())
  specBookId       String
  version          String
  status           SpecBookGenStatus @default(GENERATING)
  pdfUrl           String?
  fileSize         Int?
  pageCount        Int?
  sectionsIncluded Json
  roomsIncluded    Json
  coverPageData    Json
  errorMessage     String?
  generatedById    String
  generatedAt      DateTime          @default(now())
  completedAt      DateTime?
  downloadedAt     DateTime?
  downloadCount    Int               @default(0)
  generatedBy      User              @relation("SpecBookGeneratedBy", fields: [generatedById], references: [id])
  specBook         SpecBook          @relation("SpecBookGenerations", fields: [specBookId], references: [id], onDelete: Cascade)

  @@index([specBookId, generatedAt])
  @@index([status])
  @@index([generatedAt])
}

model CadPreferences {
  id               String   @id @default(cuid())
  linkedFileId     String   @unique
  projectId        String
  layoutName       String?
  ctbDropboxPath   String?
  ctbFileId        String?
  plotArea         String   @default("extents")
  window           Json?
  centerPlot       Boolean  @default(true)
  scaleMode        String   @default("fit")
  scaleDenominator Int?
  keepAspectRatio  Boolean  @default(true)
  margins          Json?    @default("{\"top\": 10, \"left\": 10, \"right\": 10, \"bottom\": 10}")
  paperSize        String?  @default("Auto")
  orientation      String?
  dpi              Int?     @default(300)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([linkedFileId])
  @@index([projectId])
}

model ProjectCadDefaults {
  id               String   @id @default(cuid())
  projectId        String   @unique
  layoutName       String?
  ctbDropboxPath   String?
  ctbFileId        String?
  plotArea         String   @default("extents")
  window           Json?
  centerPlot       Boolean  @default(true)
  scaleMode        String   @default("fit")
  scaleDenominator Int?
  keepAspectRatio  Boolean  @default(true)
  margins          Json?    @default("{\"top\": 10, \"left\": 10, \"right\": 10, \"bottom\": 10}")
  paperSize        String?  @default("Auto")
  orientation      String?
  dpi              Int?     @default(300)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([projectId])
}

model CadLayoutCache {
  id              String   @id @default(cuid())
  dropboxPath     String
  dropboxRevision String
  layouts         Json
  discoveredAt    DateTime @default(now())
  expiresAt       DateTime

  @@unique([dropboxPath, dropboxRevision])
  @@index([dropboxPath])
  @@index([expiresAt])
}

model DesignConceptItemLibrary {
  id          String              @id @default(cuid())
  name        String
  category    String
  description String?
  icon        String?
  order       Int                 @default(0)
  isActive    Boolean             @default(true)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  items       DesignConceptItem[]

  @@unique([name, category])
  @@index([category])
  @@index([isActive])
  @@index([category, order])
}

model DesignConceptItem {
  id                  String                        @id @default(cuid())
  stageId             String
  libraryItemId       String
  order               Int                           @default(0)
  notes               String?
  completedByRenderer Boolean                       @default(false)
  completedAt         DateTime?
  completedById       String?
  createdById         String
  updatedById         String?
  createdAt           DateTime                      @default(now())
  updatedAt           DateTime                      @updatedAt
  completedBy         User?                         @relation("DesignConceptItemCompletedBy", fields: [completedById], references: [id])
  createdBy           User                          @relation("DesignConceptItemCreatedBy", fields: [createdById], references: [id])
  libraryItem         DesignConceptItemLibrary      @relation(fields: [libraryItemId], references: [id])
  stage               Stage                         @relation(fields: [stageId], references: [id], onDelete: Cascade)
  updatedBy           User?                         @relation("DesignConceptItemUpdatedBy", fields: [updatedById], references: [id])
  attachments         DesignConceptItemAttachment[]
  images              DesignConceptItemImage[]
  links               DesignConceptItemLink[]
  itemNotes           DesignConceptItemNote[]

  @@index([stageId])
  @@index([stageId, order])
  @@index([libraryItemId])
  @@index([completedByRenderer])
}

model DesignConceptItemImage {
  id           String            @id @default(cuid())
  itemId       String
  url          String
  dropboxPath  String
  fileName     String
  fileSize     Int?
  thumbnailUrl String?
  description  String?
  order        Int               @default(0)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  item         DesignConceptItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@index([itemId, order])
}

model DesignConceptItemLink {
  id          String            @id @default(cuid())
  itemId      String
  url         String
  title       String?
  description String?
  imageUrl    String?
  siteName    String?
  favicon     String?
  order       Int               @default(0)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  item        DesignConceptItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@index([itemId, order])
}

model DesignConceptItemNote {
  id        String            @id @default(cuid())
  itemId    String
  content   String
  authorId  String
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  author    User              @relation("DesignConceptItemNoteAuthor", fields: [authorId], references: [id])
  item      DesignConceptItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@index([itemId, createdAt])
}

model DesignConceptItemAttachment {
  id          String            @id @default(cuid())
  itemId      String
  url         String
  dropboxPath String
  fileName    String
  fileSize    Int?
  fileType    String
  description String?
  order       Int               @default(0)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  item        DesignConceptItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@index([itemId, order])
}

model DesignConceptCategory {
  id        String   @id @default(cuid())
  key       String   @unique
  name      String
  icon      String?
  order     Int      @default(0)
  isDefault Boolean  @default(false)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([order])
  @@index([isDefault])
}

enum UserRole {
  OWNER
  ADMIN
  DESIGNER
  RENDERER
  DRAFTER
  FFE
  VIEWER
}

enum UserApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ContractorType {
  CONTRACTOR
  SUBCONTRACTOR
}

enum ProjectType {
  RESIDENTIAL
  COMMERCIAL
  HOSPITALITY
}

enum ProjectStatus {
  DRAFT
  IN_PROGRESS
  ON_HOLD
  URGENT
  CANCELLED
  COMPLETED
}

enum RoomType {
  ENTRANCE
  FOYER
  STAIRCASE
  LIVING_ROOM
  DINING_ROOM
  KITCHEN
  STUDY_ROOM
  OFFICE
  PLAYROOM
  MASTER_BEDROOM
  GIRLS_ROOM
  BOYS_ROOM
  GUEST_BEDROOM
  POWDER_ROOM
  MASTER_BATHROOM
  FAMILY_BATHROOM
  GIRLS_BATHROOM
  BOYS_BATHROOM
  GUEST_BATHROOM
  LAUNDRY_ROOM
  SUKKAH
  BEDROOM
  BATHROOM
  FAMILY_ROOM
  HALLWAY
  PANTRY
  LAUNDRY
  MUDROOM
  CLOSET
  OUTDOOR
  OTHER
}

enum RoomStatus {
  NOT_STARTED
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  NEEDS_ATTENTION
}

enum StageType {
  DESIGN
  DESIGN_CONCEPT
  THREE_D
  CLIENT_APPROVAL
  DRAWINGS
  FFE
  FLOORPLAN
}

enum StageStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  ON_HOLD
  NEEDS_ATTENTION
  PENDING_APPROVAL
  REVISION_REQUESTED
  NOT_APPLICABLE
}

enum TagType {
  MUST_HAVE
  OPTIONAL
  EXPLORE
  CUSTOM
}

enum FFEItemState {
  PENDING
  UNDECIDED
  SELECTED
  CONFIRMED
  NOT_NEEDED
  COMPLETED
}

enum FFETemplateStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum FFEInstanceStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

enum FFEItemVisibility {
  VISIBLE
  HIDDEN
}

enum FFEStatus {
  NOT_STARTED
  IN_PROGRESS
  SOURCING
  PROPOSED
  APPROVED
  ORDERED
  DELIVERED
  COMPLETED
  NOT_NEEDED
}

enum FFESpecStatus {
  // === PROCUREMENT WORKFLOW (auto-updated) ===
  DRAFT // Starting status
  SELECTED // Item confirmed for project
  RFQ_SENT // RFQ sent to supplier(s)
  QUOTE_RECEIVED // Quote received from supplier
  QUOTE_APPROVED // Quote approved, ready for invoicing
  BUDGET_SENT // Budget quote sent to client for approval
  BUDGET_APPROVED // Client approved budget, ready for detailed invoice
  INVOICED_TO_CLIENT // Invoice sent to client
  CLIENT_PAID // Client paid (or deposit paid)
  ORDERED // PO created, ordered from supplier
  SHIPPED // Shipped from supplier
  RECEIVED // Received at warehouse/site
  DELIVERED // Delivered to client
  INSTALLED // Installed at location
  CLOSED // Completed/Closed

  // === MANUAL STATUSES ===
  HIDDEN // Hidden from view
  CLIENT_TO_ORDER // Client will order themselves (not us)
  CONTRACTOR_TO_ORDER // Contractor will order (no price/approval needed, considered done)
  NEED_SAMPLE // Need sample before proceeding
  ISSUE // There's a problem to resolve
  ARCHIVED // Item archived, unlinked from FFE

  // === LEGACY STATUSES (kept for existing data) ===
  OPTION
  QUOTING
  PRICE_RECEIVED
  INTERNAL_REVIEW
  CLIENT_REVIEW
  RESUBMIT
  REJECTED
  APPROVED
  PAYMENT_DUE
  IN_TRANSIT
  NEEDS_SPEC
  SPEC_ADDED
  QUOTED
  BETTER_PRICE
  NEED_TO_ORDER
  IN_PRODUCTION
  COMPLETED
}

// Payment tracking status for individual items
enum ItemPaymentStatus {
  NOT_INVOICED // No client quote/invoice sent yet
  INVOICED // Client quote sent, awaiting payment
  DEPOSIT_PAID // Partial payment received
  FULLY_PAID // Full payment received
  REFUNDED // Payment was refunded
}

enum ProductLibraryStatus {
  ACTIVE
  ARCHIVED
  DISCONTINUED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REVISION_REQUESTED
  EXPIRED
}

enum ClientApprovalStageStatus {
  DRAFT
  PENDING_AARON_APPROVAL
  READY_FOR_CLIENT
  SENT_TO_CLIENT
  CLIENT_REVIEWING
  FOLLOW_UP_REQUIRED
  CLIENT_APPROVED
  REVISION_REQUESTED
}

enum FloorplanApprovalStatus {
  DRAFT
  PENDING_AARON_APPROVAL
  READY_FOR_CLIENT
  SENT_TO_CLIENT
  CLIENT_REVIEWING
  FOLLOW_UP_REQUIRED
  CLIENT_APPROVED
  REVISION_REQUESTED
}

enum AssetType {
  IMAGE
  PDF
  DOCUMENT
  LINK
  RENDER
  DRAWING
  FLOORPLAN_PDF
  FLOORPLAN_CAD
  OTHER
}

enum NotificationType {
  STAGE_ASSIGNED
  STAGE_COMPLETED
  MENTION
  CHAT_MESSAGE
  MESSAGE_REACTION
  DUE_DATE_REMINDER
  PROJECT_UPDATE
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  DONE
  CANCELLED
}

enum RenderingVersionStatus {
  IN_PROGRESS
  COMPLETED
  PUSHED_TO_CLIENT
}

enum DrawingChecklistType {
  LIGHTING
  ELEVATION
  MILLWORK
  FLOORPLAN
  CUSTOM
}

enum IssueType {
  BUG
  FEATURE_REQUEST
  UPDATE_REQUEST
  GENERAL
}

enum IssuePriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum IssueStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum ProjectUpdateType {
  GENERAL
  PHOTO
  TASK
  DOCUMENT
  COMMUNICATION
  MILESTONE
  INSPECTION
  ISSUE
}

enum ProjectUpdateCategory {
  GENERAL
  PROGRESS
  QUALITY
  SAFETY
  BUDGET
  SCHEDULE
  COMMUNICATION
  APPROVAL
}

enum ProjectUpdateStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  ON_HOLD
  REQUIRES_ATTENTION
}

enum PriorityLevel {
  URGENT
  HIGH
  MEDIUM
  LOW
  NORMAL
}

enum DocumentType {
  PLAN
  SPECIFICATION
  CHANGE_ORDER
  PERMIT
  INSPECTION_REPORT
  PHOTO
  VIDEO
  OTHER
}

enum MessageType {
  MESSAGE
  SYSTEM
  NOTIFICATION
  URGENT
  REMINDER
}

enum ChatType {
  PHASE // Message in a project phase chat
  GENERAL // General team chat (not tied to any project)
}

enum AssignmentStatus {
  ASSIGNED
  ACKNOWLEDGED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  OVERDUE
}

enum NotificationMethod {
  EMAIL
  SMS
  PUSH
  IN_APP
}

enum MilestoneType {
  CUSTOM
  PHASE_COMPLETION
  CLIENT_APPROVAL
  INSPECTION
  DELIVERY
  PAYMENT
}

enum MilestoneStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  OVERDUE
}

enum SpecBookSectionType {
  FLOORPLANS
  LIGHTING
  ELECTRICAL
  PLUMBING
  STRUCTURAL
  RCP
  ROOM
  DRAWINGS
}

enum SpecBookGenStatus {
  GENERATING
  COMPLETED
  FAILED
  CANCELLED
}

// ============================================
// TIME TRACKING MODELS
// ============================================

enum TimeEntryStatus {
  RUNNING
  PAUSED
  STOPPED
}

enum BilledStatus {
  UNBILLED
  BILLED
}

// ============================================
// RFQ SYSTEM ENUMS
// ============================================

enum RFQStatus {
  DRAFT
  SENT
  PARTIALLY_QUOTED
  FULLY_QUOTED
  QUOTE_ACCEPTED
  CANCELLED
  EXPIRED
}

enum SupplierQuoteStatus {
  PENDING
  SUBMITTED
  REVISION_REQUESTED
  REVISED
  ACCEPTED
  REJECTED
  EXPIRED
}

enum ClientQuoteStatus {
  DRAFT
  INTERNAL_REVIEW
  SENT_TO_CLIENT
  CLIENT_REVIEWING
  APPROVED
  REVISION_REQUESTED
  REJECTED
  EXPIRED
  PAID // Invoice has been paid (fully or partially)
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  REFUNDED
  FAILED
  CANCELLED
}

enum PaymentMethod {
  CREDIT_CARD
  ACH_BANK_TRANSFER
  CHECK
  WIRE_TRANSFER
  E_TRANSFER
  CASH
  OTHER
}

enum OrderStatus {
  PENDING_PAYMENT
  PAYMENT_RECEIVED // Client paid us
  DEPOSIT_PAID // We paid supplier deposit
  PAID_TO_SUPPLIER // We paid supplier in full
  ORDERED
  CONFIRMED
  IN_PRODUCTION
  SHIPPED
  IN_TRANSIT
  DELIVERED
  INSTALLED
  COMPLETED
  CANCELLED
  RETURNED
  EXCEPTION
}

enum RFQDocumentType {
  QUOTE_REQUEST
  SUPPLIER_QUOTE
  CLIENT_QUOTE
  INVOICE
  PURCHASE_ORDER
  SHIPPING_DOC
  PACKING_SLIP
  RECEIPT
  RETURN_AUTHORIZATION
  SPEC_SHEET
  DRAWING
  PHOTO
  OTHER
}

enum ShopDrawingStatus {
  PENDING
  APPROVED
  REVISION_REQUESTED
  REJECTED
}

model TimeEntry {
  id          String          @id @default(cuid())
  userId      String
  projectId   String?
  roomId      String?
  stageId     String?
  description String?
  startTime   DateTime
  endTime     DateTime?
  duration    Int? // Total minutes (calculated on stop, excludes pauses)
  status      TimeEntryStatus @default(RUNNING)
  isManual    Boolean         @default(false)
  isBillable  Boolean         @default(true)
  billedStatus BilledStatus   @default(UNBILLED)
  billedInvoiceLineItemId String?
  billedAt    DateTime?
  billedAmount Decimal?       @db.Decimal(10, 2)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  user    User            @relation("UserTimeEntries", fields: [userId], references: [id], onDelete: Cascade)
  project Project?        @relation("ProjectTimeEntries", fields: [projectId], references: [id], onDelete: SetNull)
  room    Room?           @relation("RoomTimeEntries", fields: [roomId], references: [id], onDelete: SetNull)
  stage   Stage?          @relation("StageTimeEntries", fields: [stageId], references: [id], onDelete: SetNull)
  billedInvoiceLineItem BillingInvoiceLineItem? @relation("LinkedTimeEntries", fields: [billedInvoiceLineItemId], references: [id], onDelete: SetNull)
  pauses  TimePause[]
  edits   TimeEntryEdit[]

  @@index([userId])
  @@index([userId, status])
  @@index([userId, startTime])
  @@index([projectId])
  @@index([startTime])
  @@index([projectId, billedStatus])
  @@index([billedInvoiceLineItemId])
}

model TimePause {
  id          String    @id @default(cuid())
  timeEntryId String
  pausedAt    DateTime  @default(now())
  resumedAt   DateTime?
  duration    Int? // Pause duration in minutes (calculated on resume)
  createdAt   DateTime  @default(now())

  timeEntry TimeEntry @relation(fields: [timeEntryId], references: [id], onDelete: Cascade)

  @@index([timeEntryId])
}

model TimeEntryEdit {
  id            String   @id @default(cuid())
  timeEntryId   String
  editedById    String
  field         String // Which field was changed
  previousValue String? // JSON string of previous value
  newValue      String? // JSON string of new value
  reason        String?
  createdAt     DateTime @default(now())

  timeEntry TimeEntry @relation(fields: [timeEntryId], references: [id], onDelete: Cascade)
  editedBy  User      @relation("UserTimeEntryEdits", fields: [editedById], references: [id])

  @@index([timeEntryId])
  @@index([editedById])
}

model UserTimeSettings {
  id               String   @id @default(cuid())
  userId           String   @unique
  defaultProjectId String?
  autoStopMinutes  Int      @default(0) // 0 = disabled
  weekStartsOn     Int      @default(0) // 0 = Sunday, 1 = Monday, etc.
  dailyTargetHours Float    @default(8)
  recentProjects   Json? // Array of {projectId, roomId, stageId, description}
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user User @relation("UserTimeSettings", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// User off days for time tracking (vacation, sick days, etc.)
model UserOffDay {
  id        String      @id @default(cuid())
  userId    String
  date      DateTime    @db.Date // The specific day off
  reason    OffDayType  @default(VACATION)
  notes     String?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  user User @relation("UserOffDays", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date]) // One entry per user per day
  @@index([userId])
  @@index([userId, date])
  @@index([date])
}

enum OffDayType {
  VACATION
  SICK
  PERSONAL
  HOLIDAY
  OTHER
}

// Floorplan Chat Models
model FloorplanChatMessage {
  id              String    @id @default(cuid())
  projectId       String
  authorId        String
  content         String
  parentMessageId String?
  imageUrl        String?
  imageFileName   String?
  editedAt        DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  project       Project                   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  author        User                      @relation("FloorplanChatAuthor", fields: [authorId], references: [id])
  parentMessage FloorplanChatMessage?     @relation("FloorplanChatReplies", fields: [parentMessageId], references: [id], onDelete: SetNull)
  replies       FloorplanChatMessage[]    @relation("FloorplanChatReplies")
  mentions      FloorplanChatMention[]
  reactions     FloorplanChatReaction[]
  attachments   FloorplanChatAttachment[]

  @@index([projectId])
  @@index([authorId])
  @@index([createdAt])
}

model FloorplanChatMention {
  id              String   @id @default(cuid())
  messageId       String
  mentionedUserId String
  createdAt       DateTime @default(now())

  message       FloorplanChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  mentionedUser User                 @relation("FloorplanChatMentioned", fields: [mentionedUserId], references: [id])

  @@unique([messageId, mentionedUserId])
  @@index([messageId])
  @@index([mentionedUserId])
}

model FloorplanChatReaction {
  id        String   @id @default(cuid())
  messageId String
  userId    String
  emoji     String
  createdAt DateTime @default(now())

  message FloorplanChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User                 @relation("FloorplanChatReactor", fields: [userId], references: [id])

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@index([userId])
}

model FloorplanChatAttachment {
  id        String   @id @default(cuid())
  messageId String
  assetId   String
  name      String
  url       String
  type      String
  size      Int
  createdAt DateTime @default(now())

  message FloorplanChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  asset   Asset                @relation("FloorplanChatAssets", fields: [assetId], references: [id])

  @@unique([messageId, assetId])
  @@index([messageId])
  @@index([assetId])
}

// ============================================
// RFQ SYSTEM MODELS
// ============================================

// Request for Quote - Sent to one or more suppliers
model RFQ {
  id          String    @id @default(cuid())
  orgId       String
  projectId   String
  rfqNumber   String // Auto-generated: RFQ-2024-0001
  title       String
  description String?
  status      RFQStatus @default(DRAFT)

  // Grouping - allows grouping items by category for bulk RFQ
  groupingType   String? // 'category' | 'individual' | 'custom'
  categoryFilter String? // e.g., 'Plumbing', 'Electrical'

  // Timing
  validUntil       DateTime?
  responseDeadline DateTime?

  // Tracking
  sentAt   DateTime?
  sentById String?

  createdById String
  updatedById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  project           Project            @relation("ProjectRFQs", fields: [projectId], references: [id], onDelete: Cascade)
  sentBy            User?              @relation("RFQSentBy", fields: [sentById], references: [id])
  createdBy         User               @relation("RFQCreatedBy", fields: [createdById], references: [id])
  updatedBy         User               @relation("RFQUpdatedBy", fields: [updatedById], references: [id])
  lineItems         RFQLineItem[]
  supplierRFQs      SupplierRFQ[]
  documents         RFQDocument[]
  activities        RFQActivity[]
  itemQuoteRequests ItemQuoteRequest[] @relation("RFQQuoteRequests")

  @@unique([orgId, rfqNumber])
  @@index([orgId])
  @@index([projectId])
  @@index([status])
  @@index([createdAt])
}

// Line items in an RFQ - links to RoomFFEItem specs
model RFQLineItem {
  id            String @id @default(cuid())
  rfqId         String
  roomFFEItemId String // Link to spec item (isSpecItem=true)

  // Copied data for reference (in case spec changes)
  itemName        String
  itemDescription String?
  quantity        Int     @default(1)
  unitType        String? @default("units")
  specifications  Json? // Dimensions, color, finish, etc.

  // Optional target pricing for negotiation
  targetUnitPrice  Decimal?
  targetTotalPrice Decimal?

  notes     String?
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rfq            RFQ                     @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  roomFFEItem    RoomFFEItem             @relation("RFQLineItems", fields: [roomFFEItemId], references: [id])
  quoteLineItems SupplierQuoteLineItem[]

  @@index([rfqId])
  @@index([roomFFEItemId])
}

// Tracks RFQ sent to specific supplier
model SupplierRFQ {
  id         String  @id @default(cuid())
  rfqId      String
  supplierId String? // Null for one-time vendors

  // One-time vendor info (when supplierId is null)
  vendorName    String?
  vendorEmail   String?
  vendorPhone   String?
  vendorCompany String?

  // Access token for supplier portal
  accessToken    String    @unique @default(cuid())
  tokenExpiresAt DateTime?

  // Tracking
  sentAt         DateTime?
  viewedAt       DateTime?
  lastAccessedAt DateTime?
  accessCount    Int       @default(0)

  // Response
  responseStatus String    @default("PENDING") // PENDING, SUBMITTED, DECLINED
  respondedAt    DateTime?
  declineReason  String?

  // Custom shipping address (if different from project)
  shippingAddress Json? // { street, city, province, postalCode, country }

  // Content visibility settings for supplier portal
  includeSpecSheet Boolean @default(true) // Show spec sheets/documents in portal
  includeNotes     Boolean @default(true) // Show item notes in portal

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rfq        RFQ                 @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  supplier   Supplier?           @relation(fields: [supplierId], references: [id])
  quotes     SupplierQuote[]
  accessLogs SupplierAccessLog[]

  @@unique([rfqId, supplierId])
  @@index([rfqId])
  @@index([supplierId])
  @@index([accessToken])
}

// Supplier access logging
model SupplierAccessLog {
  id            String   @id @default(cuid())
  supplierRFQId String
  ipAddress     String?
  userAgent     String?
  action        String // 'VIEW', 'DOWNLOAD', 'SUBMIT_QUOTE', etc.
  metadata      Json?
  createdAt     DateTime @default(now())

  supplierRFQ SupplierRFQ @relation(fields: [supplierRFQId], references: [id], onDelete: Cascade)

  @@index([supplierRFQId])
  @@index([createdAt])
}

// Quote submitted by supplier
model SupplierQuote {
  id            String @id @default(cuid())
  supplierRFQId String
  quoteNumber   String // Supplier's quote reference
  version       Int    @default(1)

  status SupplierQuoteStatus @default(PENDING)

  // Pricing Summary
  subtotal     Decimal?
  taxAmount    Decimal?
  shippingCost Decimal?
  totalAmount  Decimal?
  currency     String   @default("CAD")

  // Deposit
  depositRequired Decimal? // Deposit amount required before production/shipping
  depositPercent  Decimal? // Deposit as percentage of total

  // Terms
  validUntil        DateTime?
  paymentTerms      String?
  shippingTerms     String?
  estimatedLeadTime String?

  // Notes
  supplierNotes String?
  internalNotes String?

  // Document
  quoteDocumentUrl String? // Uploaded quote document (PDF, etc.)

  // Tracking
  submittedAt  DateTime?
  reviewedAt   DateTime?
  reviewedById String?
  acceptedAt   DateTime?
  acceptedById String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  supplierRFQ      SupplierRFQ             @relation(fields: [supplierRFQId], references: [id], onDelete: Cascade)
  reviewedBy       User?                   @relation("QuoteReviewedBy", fields: [reviewedById], references: [id])
  acceptedBy       User?                   @relation("QuoteAcceptedBy", fields: [acceptedById], references: [id])
  lineItems        SupplierQuoteLineItem[]
  documents        RFQDocument[]           @relation("SupplierQuoteDocuments")
  clientQuoteLines ClientQuoteLineItem[]

  @@index([supplierRFQId])
  @@index([status])
  @@index([version])
}

// Individual line item in supplier quote
model SupplierQuoteLineItem {
  id              String @id @default(cuid())
  supplierQuoteId String
  rfqLineItemId   String

  // === DIRECT ITEM LINK ===
  // Direct link to RoomFFEItem (in addition to going through RFQLineItem)
  // This enables tracking all quotes for an item directly
  roomFFEItemId String?

  // Pricing
  unitPrice        Decimal
  quantity         Int
  originalQuantity Int? // Original qty from RFQ - if different from quantity, supplier changed it
  totalPrice       Decimal
  currency         String  @default("CAD")

  // Availability
  availability  String? // 'IN_STOCK', 'BACKORDER', 'SPECIAL_ORDER'
  leadTimeWeeks Int?
  leadTimeNotes String?
  leadTime      String? // Human-readable: 'in-stock', '2-4-weeks', etc.

  // Product info
  itemName            String? // Item name from supplier's quote
  supplierSKU         String?
  supplierModelNumber String?
  alternateProduct    Boolean @default(false)
  alternateNotes      String?

  // Match verification
  matchApproved     Boolean   @default(false)
  matchApprovedAt   DateTime?
  matchApprovedById String?

  // === QUOTE ACCEPTANCE ===
  // When this quote line is selected as THE quote for an item
  isAccepted   Boolean   @default(false)
  acceptedAt   DateTime?
  acceptedById String?

  // === QUOTE VERSIONING ===
  // Track revisions from the same supplier
  quoteVersion      Int     @default(1)
  isLatestVersion   Boolean @default(true)
  previousVersionId String? // Links to previous quote version from same supplier

  // Approved markup (set when quote is accepted)
  approvedMarkupPercent Decimal? // Markup % approved when accepting quote

  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  supplierQuote   SupplierQuote @relation(fields: [supplierQuoteId], references: [id], onDelete: Cascade)
  rfqLineItem     RFQLineItem   @relation(fields: [rfqLineItemId], references: [id])
  matchApprovedBy User?         @relation("MatchApprovedBy", fields: [matchApprovedById], references: [id])
  acceptedBy      User?         @relation("QuoteLineAcceptedBy", fields: [acceptedById], references: [id])

  // Direct item relation
  roomFFEItem    RoomFFEItem? @relation("ItemQuoteLineItems", fields: [roomFFEItemId], references: [id], onDelete: SetNull)
  acceptedByItem RoomFFEItem? @relation("AcceptedQuoteForItem") // Reverse of RoomFFEItem.acceptedQuoteLineItem

  // Order items created from this quote
  orderItems OrderItem[]

  // Self-reference for quote versioning
  previousVersion SupplierQuoteLineItem?  @relation("QuoteLineVersions", fields: [previousVersionId], references: [id])
  newerVersions   SupplierQuoteLineItem[] @relation("QuoteLineVersions")

  @@index([supplierQuoteId])
  @@index([rfqLineItemId])
  @@index([roomFFEItemId])
  @@index([isAccepted])
  @@index([isLatestVersion])
}

// Quote sent to client (with markup applied)
model ClientQuote {
  id          String @id @default(cuid())
  orgId       String
  projectId   String
  quoteNumber String // CQ-2024-0001
  version     Int    @default(1)

  title       String
  description String?
  status      ClientQuoteStatus @default(DRAFT)

  // Grouping
  groupingType String? // 'category' | 'room' | 'custom'
  groupTitle   String?

  // Pricing Summary (after markup)
  subtotal     Decimal?
  taxRate      Decimal? @default(0)
  taxAmount    Decimal?
  shippingCost Decimal? // Delivery/shipping fee
  customFees   Json? // Array of {name: string, amount: number} for duties, handling, etc.
  totalAmount  Decimal?
  currency     String   @default("CAD")

  // GST/QST Tax Breakdown
  gstRate   Decimal? @default(5.0)
  gstAmount Decimal?
  qstRate   Decimal? @default(9.975)
  qstAmount Decimal?

  // Default markup for this quote
  defaultMarkupPercent Decimal? @default(25)

  // Terms
  validUntil      DateTime?
  paymentTerms    String?
  depositRequired Decimal?
  depositAmount   Decimal?

  // Client Info Snapshot (for invoice)
  clientName    String?
  clientEmail   String?
  clientPhone   String?
  clientAddress String?

  // Payment Method
  selectedPaymentMethod String? // CREDIT_CARD, WIRE, CHECK, CASH
  ccSurchargePercent    Decimal? @default(3.0)
  ccSurchargeAmount     Decimal?
  allowCreditCard       Boolean  @default(true)

  // Email tracking
  sentToClientAt DateTime?
  sentById       String?
  emailOpenedAt  DateTime?

  // Client response
  clientDecision  String?
  clientDecidedAt DateTime?
  clientMessage   String?

  // Access
  accessToken String @unique @default(cuid())

  // Dropbox integration
  dropboxPdfPath String? // Path to invoice PDF in Dropbox
  dropboxPdfUrl  String? // Shared link for the PDF

  createdById String
  updatedById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project    Project               @relation("ProjectClientQuotes", fields: [projectId], references: [id], onDelete: Cascade)
  sentBy     User?                 @relation("ClientQuoteSentBy", fields: [sentById], references: [id])
  createdBy  User                  @relation("ClientQuoteCreatedBy", fields: [createdById], references: [id])
  updatedBy  User                  @relation("ClientQuoteUpdatedBy", fields: [updatedById], references: [id])
  lineItems  ClientQuoteLineItem[]
  documents  RFQDocument[]         @relation("ClientQuoteDocuments")
  payments   Payment[]
  emailLogs  ClientQuoteEmailLog[]
  activities ClientQuoteActivity[]

  @@unique([orgId, quoteNumber])
  @@index([orgId])
  @@index([projectId])
  @@index([status])
  @@index([accessToken])
}

// Line item in client quote
model ClientQuoteLineItem {
  id              String  @id @default(cuid())
  clientQuoteId   String
  supplierQuoteId String?
  roomFFEItemId   String? // Optional - may not link to spec item for manual entries

  // Display info (client sees this)
  displayName        String
  displayDescription String?
  categoryName       String?
  roomName           String?
  imageUrl           String? // Image URL for display (especially for components)
  isComponent        Boolean @default(false) // Flag for component items

  // Quantity
  quantity Int     @default(1)
  unitType String? @default("units")

  // Pricing - what client sees (markup applied)
  clientUnitPrice  Decimal
  clientTotalPrice Decimal
  currency         String? @default("CAD") // Currency: CAD or USD

  // Hidden pricing - what designer paid
  supplierUnitPrice  Decimal?
  supplierTotalPrice Decimal?

  // Markup
  markupType   String?  @default("PERCENTAGE")
  markupValue  Decimal?
  markupAmount Decimal?

  // Grouping
  groupId   String?
  groupName String?
  order     Int     @default(0)

  notes         String?
  internalNotes String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  clientQuote   ClientQuote    @relation(fields: [clientQuoteId], references: [id], onDelete: Cascade)
  supplierQuote SupplierQuote? @relation(fields: [supplierQuoteId], references: [id])
  roomFFEItem   RoomFFEItem?   @relation("ClientQuoteLineItems", fields: [roomFFEItemId], references: [id], onDelete: SetNull)
  orderItems    OrderItem[]

  @@index([clientQuoteId])
  @@index([roomFFEItemId])
  @@index([groupId])
}

// Category-level markup defaults
model CategoryMarkup {
  id            String   @id @default(cuid())
  orgId         String
  categoryName  String
  markupPercent Decimal  @default(25)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([orgId, categoryName])
  @@index([orgId])
}

// Email logs for client quotes
model ClientQuoteEmailLog {
  id              String    @id @default(cuid())
  clientQuoteId   String
  to              String
  subject         String
  htmlContent     String
  sentAt          DateTime  @default(now())
  openedAt        DateTime?
  clickedAt       DateTime?
  trackingPixelId String    @unique

  clientQuote ClientQuote @relation(fields: [clientQuoteId], references: [id], onDelete: Cascade)

  @@index([clientQuoteId])
}

// Activity log for client quotes
model ClientQuoteActivity {
  id            String   @id @default(cuid())
  clientQuoteId String
  type          String
  message       String
  userId        String?
  metadata      Json?
  createdAt     DateTime @default(now())

  clientQuote ClientQuote @relation(fields: [clientQuoteId], references: [id], onDelete: Cascade)
  user        User?       @relation("ClientQuoteActivityUser", fields: [userId], references: [id])

  @@index([clientQuoteId])
  @@index([createdAt])
}

// Budget Quote - simplified estimate sent to client for bulk approval
model BudgetQuote {
  id        String @id @default(cuid())
  orgId     String
  projectId String
  token     String @unique @default(cuid()) // Public access token

  // Display
  title       String // e.g., "Tiles – Main Floor"
  description String? // What's included text

  // Items
  itemIds          String[] // Array of RoomFFEItem IDs
  supplierQuoteIds String[] // Array of SupplierQuote IDs (if created from quotes)

  // Pricing
  estimatedTotal Decimal // Total estimate
  markupPercent  Decimal? // Markup applied (if any)
  currency       String   @default("CAD")
  includeTax     Boolean  @default(true) // Show "+ tax" message

  // Included services (displayed as bullet points)
  includedServices String[] // e.g., ["Material selection", "Supplier coordination"]

  // Status
  status String @default("PENDING") // PENDING, APPROVED, QUESTION_ASKED, EXPIRED

  // Client response
  clientApproved   Boolean   @default(false)
  clientApprovedAt DateTime?
  clientQuestion   String? // If they asked a question
  clientQuestionAt DateTime?
  clientEmail      String? // For sending response

  // Email tracking
  sentAt        DateTime?
  sentToEmail   String?
  emailOpenedAt DateTime?
  viewedAt      DateTime? // When client viewed the portal

  // Validity
  expiresAt DateTime?

  // Audit
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  org       Organization @relation("BudgetQuoteOrg", fields: [orgId], references: [id])
  project   Project      @relation("BudgetQuoteProject", fields: [projectId], references: [id])
  createdBy User         @relation("BudgetQuoteCreatedBy", fields: [createdById], references: [id])

  @@index([orgId])
  @@index([projectId])
  @@index([token])
  @@index([status])
}

// Payment tracking
model Payment {
  id            String @id @default(cuid())
  orgId         String
  clientQuoteId String

  // Amount
  amount   Decimal
  currency String  @default("CAD")

  // Payment info
  method PaymentMethod
  status PaymentStatus @default(PENDING)

  // External references
  stripePaymentId    String?
  stripeChargeId     String?
  nuveiTransactionId String?
  achTransactionId   String?
  checkNumber        String?
  wireReference      String?

  // Tracking
  paidAt        DateTime?
  confirmedAt   DateTime?
  confirmedById String?

  // Proof of payment
  proofDocumentUrl String?
  proofFileName    String?

  // Reconciliation
  reconciled      Boolean   @default(false)
  reconciledAt    DateTime?
  reconciledById  String?
  reconciledNotes String?

  notes    String?
  metadata Json?

  createdById String? // Optional for webhook-created payments
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  clientQuote  ClientQuote   @relation(fields: [clientQuoteId], references: [id], onDelete: Cascade)
  confirmedBy  User?         @relation("PaymentConfirmedBy", fields: [confirmedById], references: [id])
  reconciledBy User?         @relation("PaymentReconciledBy", fields: [reconciledById], references: [id])
  createdBy    User?         @relation("PaymentCreatedBy", fields: [createdById], references: [id])
  documents    RFQDocument[] @relation("PaymentDocuments")

  @@index([orgId])
  @@index([clientQuoteId])
  @@index([status])
  @@index([method])
}

// Saved payment methods for supplier payments (credit cards, bank accounts)
model SavedPaymentMethod {
  id    String @id @default(cuid())
  orgId String

  // Payment method type
  type String // CREDIT_CARD, DEBIT_CARD, BANK_ACCOUNT

  // Display info (masked)
  nickname    String? // "Company Visa", "Operating Account"
  lastFour    String? // Last 4 digits of card/account
  cardBrand   String? // VISA, MASTERCARD, AMEX
  expiryMonth Int? // Card expiry month
  expiryYear  Int? // Card expiry year
  bankName    String? // Bank name for bank accounts

  // Full card details (encrypted for supplier charging)
  // WARNING: These fields store sensitive payment data - encrypted at rest
  encryptedCardNumber String? // AES-256 encrypted full card number
  encryptedCvv        String? // AES-256 encrypted CVV

  // Billing address for payment method
  billingAddress  String? // Full billing address
  billingCity     String?
  billingProvince String?
  billingPostal   String?
  billingCountry  String? @default("Canada")

  // Cardholder/Account info
  holderName String? // Name on card or account holder

  // Status
  isActive  Boolean @default(true)
  isDefault Boolean @default(false) // Default payment method

  // Notes
  notes String?

  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  createdBy User?   @relation("PaymentMethodCreatedBy", fields: [createdById], references: [id])
  orders    Order[] @relation("OrderPaymentMethod")

  @@index([orgId])
  @@index([isActive])
}

// Order placed with supplier after payment
model Order {
  id        String @id @default(cuid())
  orgId     String
  projectId String

  orderNumber      String // PO-2024-0001
  supplierOrderRef String?

  supplierId  String?
  vendorName  String?
  vendorEmail String?

  status OrderStatus @default(PENDING_PAYMENT)

  // Amounts
  subtotal     Decimal?
  taxAmount    Decimal?
  shippingCost Decimal?
  extraCharges Json? // Array of {label: string, amount: number} for customs, handling, etc.
  totalAmount  Decimal?
  currency     String   @default("CAD")

  // Dates
  orderedAt        DateTime?
  confirmedAt      DateTime?
  expectedShipDate DateTime?
  actualShipDate   DateTime?
  expectedDelivery DateTime?
  actualDelivery   DateTime?

  // Shipping
  shippingMethod        String?
  trackingNumber        String?
  trackingUrl           String?
  shippingCarrier       String?
  shippingRecipientName String? // Name from saved address (e.g., "Warehouse", "Office") or client name
  shippingAddress       String?

  // Billing Address (from Organization or custom)
  billingAddress String? // Full billing address to display on PO

  // Payment Card Info for PO (from saved payment method, displayed to supplier)
  paymentCardBrand      String? // VISA, MASTERCARD, AMEX
  paymentCardLastFour   String? // Last 4 digits for display
  paymentCardHolderName String? // Cardholder name
  paymentCardExpiry     String? // MM/YY format
  paymentCardNumber     String? // Full card number (encrypted, for supplier to charge)
  paymentCardCvv        String? // CVV (encrypted, for supplier to charge)

  // Deposit & Payment Tracking
  depositRequired Decimal? // Deposit amount required (from supplier quote)
  depositPercent  Decimal? // Deposit as percentage
  depositPaid     Decimal? // Amount of deposit paid
  depositPaidAt   DateTime? // When deposit was paid
  balanceDue      Decimal? // Remaining balance after deposit
  balancePaidAt   DateTime? // When balance was paid

  // Supplier Payment Tracking
  supplierPaidAt        DateTime? // When we paid the supplier (full or deposit)
  supplierPaymentMethod String? // How we paid (wire, check, credit, etc.)
  supplierPaymentRef    String? // Reference number/confirmation
  supplierPaymentAmount Decimal? // Total amount paid to supplier
  supplierPaymentNotes  String? // Any notes about the payment
  savedPaymentMethodId  String? // Link to saved payment method used

  notes         String?
  internalNotes String?

  // Supplier Portal Access
  supplierAccessToken    String?   @unique @default(cuid())
  supplierTokenExpiresAt DateTime?
  supplierViewedAt       DateTime? // When supplier first viewed the PO
  supplierConfirmedAt    DateTime? // When supplier confirmed receipt
  supplierConfirmedBy    String? // Name of person who confirmed

  createdById String
  updatedById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project            Project             @relation("ProjectOrders", fields: [projectId], references: [id], onDelete: Cascade)
  supplier           Supplier?           @relation(fields: [supplierId], references: [id])
  savedPaymentMethod SavedPaymentMethod? @relation("OrderPaymentMethod", fields: [savedPaymentMethodId], references: [id])
  createdBy          User                @relation("OrderCreatedBy", fields: [createdById], references: [id])
  updatedBy          User                @relation("OrderUpdatedBy", fields: [updatedById], references: [id])
  items              OrderItem[]
  documents          RFQDocument[]       @relation("OrderDocuments")
  activities         OrderActivity[]
  deliveries         Delivery[]
  messages           SupplierMessage[]

  @@unique([orgId, orderNumber])
  @@index([supplierAccessToken])
  @@index([orgId])
  @@index([projectId])
  @@index([supplierId])
  @@index([status])
}

// Individual items in an order
model OrderItem {
  id                      String  @id @default(cuid())
  orderId                 String
  clientQuoteLineItemId   String?
  roomFFEItemId           String
  supplierQuoteLineItemId String? // Link to the supplier quote we're ordering from
  componentId             String? // Link to ItemComponent if this is a component

  // Item info
  name        String
  description String?
  roomName    String? // Room name for display
  imageUrl    String? // Image URL for display
  quantity    Int
  unitType    String?

  // Component tracking
  isComponent  Boolean @default(false) // True if this is a component of another item
  parentItemId String? // Parent RoomFFEItem ID if this is a component

  // Pricing (from supplier quote)
  unitPrice  Decimal
  totalPrice Decimal

  // Status tracking
  status OrderStatus @default(PENDING_PAYMENT)

  // Delivery tracking
  expectedDelivery DateTime?
  actualDelivery   DateTime?
  deliveryId       String?

  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  order                 Order                  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  clientQuoteLineItem   ClientQuoteLineItem?   @relation(fields: [clientQuoteLineItemId], references: [id])
  roomFFEItem           RoomFFEItem            @relation("OrderItems", fields: [roomFFEItemId], references: [id])
  supplierQuoteLineItem SupplierQuoteLineItem? @relation(fields: [supplierQuoteLineItemId], references: [id])
  delivery              Delivery?              @relation(fields: [deliveryId], references: [id])

  @@index([orderId])
  @@index([roomFFEItemId])
  @@index([supplierQuoteLineItemId])
  @@index([status])
}

// Delivery tracking
model Delivery {
  id      String @id @default(cuid())
  orderId String

  deliveryNumber String?
  carrier        String?
  trackingNumber String?
  trackingUrl    String?

  status String @default("PENDING")

  expectedDate DateTime?
  actualDate   DateTime?

  recipientName String?
  signedBy      String?

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  order     Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  items     OrderItem[]
  documents RFQDocument[] @relation("DeliveryDocuments")

  @@index([orderId])
  @@index([trackingNumber])
}

// Order activity log
model OrderActivity {
  id        String   @id @default(cuid())
  orderId   String
  type      String
  message   String
  userId    String?
  metadata  Json?
  createdAt DateTime @default(now())

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user  User? @relation("OrderActivityUser", fields: [userId], references: [id])

  @@index([orderId])
  @@index([createdAt])
}

// Documents for RFQ system
model RFQDocument {
  id    String @id @default(cuid())
  orgId String

  // Link to various entities (one or more can be set)
  rfqId           String?
  supplierQuoteId String?
  clientQuoteId   String?
  paymentId       String?
  orderId         String?
  deliveryId      String?
  specItemId      String? // Direct link to a spec item (RoomFFEItem)

  // Document info
  type        RFQDocumentType
  title       String
  description String?

  // File info
  fileName String
  fileUrl  String
  fileSize Int?
  mimeType String?

  // Storage provider
  provider    String?
  dropboxPath String?

  // Visibility
  visibleToClient   Boolean @default(false)
  visibleToSupplier Boolean @default(false)

  uploadedById String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  rfq           RFQ?           @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  supplierQuote SupplierQuote? @relation("SupplierQuoteDocuments", fields: [supplierQuoteId], references: [id], onDelete: Cascade)
  clientQuote   ClientQuote?   @relation("ClientQuoteDocuments", fields: [clientQuoteId], references: [id], onDelete: Cascade)
  payment       Payment?       @relation("PaymentDocuments", fields: [paymentId], references: [id], onDelete: Cascade)
  order         Order?         @relation("OrderDocuments", fields: [orderId], references: [id], onDelete: Cascade)
  delivery      Delivery?      @relation("DeliveryDocuments", fields: [deliveryId], references: [id], onDelete: Cascade)
  specItem      RoomFFEItem?   @relation("SpecItemDocuments", fields: [specItemId], references: [id], onDelete: Cascade)
  uploadedBy    User           @relation("RFQDocumentUploadedBy", fields: [uploadedById], references: [id])

  @@index([orgId])
  @@index([rfqId])
  @@index([supplierQuoteId])
  @@index([clientQuoteId])
  @@index([orderId])
  @@index([specItemId])
  @@index([type])
}

// RFQ activity log
model RFQActivity {
  id        String   @id @default(cuid())
  rfqId     String
  type      String
  message   String
  userId    String?
  metadata  Json?
  createdAt DateTime @default(now())

  rfq  RFQ   @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  user User? @relation("RFQActivityUser", fields: [userId], references: [id])

  @@index([rfqId])
  @@index([createdAt])
}

// Supplier messaging (integrated with main messaging)
model SupplierMessage {
  id         String  @id @default(cuid())
  orgId      String
  supplierId String
  projectId  String?
  orderId    String?

  // Message content
  content     String
  attachments Json?

  // Direction
  direction String // 'INBOUND' | 'OUTBOUND'

  // Sender info
  senderType   String // 'SUPPLIER' | 'TEAM'
  senderUserId String?
  senderName   String?

  // Read tracking
  readAt       DateTime?
  readByUserId String?

  isDeleted Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  supplier   Supplier @relation(fields: [supplierId], references: [id])
  project    Project? @relation("ProjectSupplierMessages", fields: [projectId], references: [id])
  order      Order?   @relation(fields: [orderId], references: [id])
  senderUser User?    @relation("SupplierMessageSender", fields: [senderUserId], references: [id])
  readByUser User?    @relation("SupplierMessageReadBy", fields: [readByUserId], references: [id])

  @@index([orgId])
  @@index([supplierId])
  @@index([projectId])
  @@index([createdAt])
}

// Shop drawings uploaded by suppliers
model SupplierShopDrawing {
  id         String  @id @default(cuid())
  orgId      String
  supplierId String
  projectId  String
  orderId    String?

  // File info
  title       String
  description String?
  fileName    String
  fileUrl     String
  fileSize    Int?
  version     Int     @default(1)

  // Review workflow
  status       ShopDrawingStatus @default(PENDING)
  reviewedById String?
  reviewedAt   DateTime?
  reviewNotes  String?

  // Tracking
  uploadedAt DateTime @default(now())
  updatedAt  DateTime @updatedAt

  supplier   Supplier @relation(fields: [supplierId], references: [id])
  project    Project  @relation("ProjectShopDrawings", fields: [projectId], references: [id])
  reviewedBy User?    @relation("ShopDrawingReviewedBy", fields: [reviewedById], references: [id])

  @@index([supplierId])
  @@index([projectId])
  @@index([status])
}

// Spec Share Links - shareable links for specs with customizable visibility
model SpecShareLink {
  id        String @id @default(cuid())
  projectId String

  // Link identification
  token String  @unique @default(cuid())
  name  String? // e.g., "Client", "Contractor", "Architect"

  // Item selection - array of RoomFFEItem IDs to share
  itemIds String[]

  // Visibility settings
  showSupplier   Boolean @default(false)
  showBrand      Boolean @default(true)
  showPricing    Boolean @default(false)
  showDetails    Boolean @default(true)
  showSpecSheets Boolean @default(false) // Show spec sheet PDFs/attachments
  showNotes      Boolean @default(true) // Show item notes/description

  // Client approval feature
  allowApproval Boolean @default(false) // Allow recipient to approve items

  // Expiry (optional - null means no expiry)
  expiresAt DateTime?

  // Status
  active Boolean @default(true)

  // Tracking
  viewedAt       DateTime?
  lastAccessedAt DateTime?
  accessCount    Int       @default(0)

  // Audit
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  project   Project @relation("ProjectSpecShareLinks", fields: [projectId], references: [id], onDelete: Cascade)
  createdBy User    @relation("SpecShareLinkCreatedBy", fields: [createdById], references: [id])

  @@index([projectId])
  @@index([token])
  @@index([active])
}

// Programa Import - Temporary import from Excel for linking to FFE items
model ProgramaItem {
  id    String @id @default(cuid())
  orgId String

  // Category/Section from Excel
  category String

  // Product Info
  name        String // Product Name
  description String? // Product Description
  details     String? // Product Details (rooms)
  brand       String?
  sku         String?
  docCode     String?

  // Appearance
  color    String?
  finish   String?
  material String?

  // Dimensions
  width  String?
  length String?
  height String?
  depth  String?

  // Pricing
  quantity       Int      @default(0)
  rrp            Decimal?
  tradePrice     Decimal?
  tradeDiscount  Decimal?
  totalCost      Decimal?
  markup         Decimal?
  clientPriceExc Decimal?
  taxAmount      Decimal?
  clientPriceInc Decimal?
  clientDiscount Decimal?
  profit         Decimal?

  // Supplier Info
  supplierCompanyName String?
  supplierName        String?
  supplierEmail       String?
  supplierPhone       String?
  supplierAddress     String?
  websiteUrl          String?

  // Status & Notes
  status        String? @default("draft")
  importantInfo String?
  notes         String?
  leadTime      String?

  // Image
  imageUrl String?

  // Link tracking - which FFE item this is linked to
  linkedRoomFFEItemId String?
  linkedAt            DateTime?
  linkedById          String?

  // Import tracking
  importBatchId String? // To group items from same import
  rowNumber     Int? // Original row in Excel

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization      Organization @relation("OrgProgramaItems", fields: [orgId], references: [id], onDelete: Cascade)
  linkedRoomFFEItem RoomFFEItem? @relation("ProgramaLinkedItem", fields: [linkedRoomFFEItemId], references: [id], onDelete: SetNull)
  linkedBy          User?        @relation("ProgramaLinkedBy", fields: [linkedById], references: [id])

  @@index([orgId])
  @@index([category])
  @@index([linkedRoomFFEItemId])
  @@index([importBatchId])
}

// ========================================
// BILLING SYSTEM - PROPOSALS & INVOICES
// ========================================

enum ProposalStatus {
  DRAFT
  SENT
  VIEWED
  SIGNED
  EXPIRED
  DECLINED
}

enum ProposalBillingType {
  FIXED
  HOURLY
  HYBRID // Fixed price with hourly for additional work
}

model Proposal {
  id             String         @id @default(cuid())
  orgId          String
  projectId      String
  proposalNumber String // e.g., "P-2026-001"
  title          String
  status         ProposalStatus @default(DRAFT)

  // Billing type
  billingType ProposalBillingType @default(HYBRID)

  // Content stored as JSON
  content Json? // { scope, deliverables, timeline, pricing, terms }

  // Cover letter (personalized letter to client)
  coverLetter String? @db.Text

  // Payment schedule as JSON array
  // [{ title: "Deposit to begin", amount: 8000, percent: null, dueOn: "signing" },
  //  { title: "Completion of Design", amount: 7000, percent: null, dueOn: "milestone" }]
  paymentSchedule Json?

  // Client info
  clientName     String
  clientEmail    String
  clientPhone    String?
  clientAddress  String?
  projectAddress String? // Project site address (may differ from client)

  // Financial
  subtotal        Decimal  @db.Decimal(12, 2)
  discountPercent Decimal? @db.Decimal(5, 2)
  discountAmount  Decimal? @db.Decimal(12, 2)
  gstRate         Decimal? @db.Decimal(5, 3)
  gstAmount       Decimal? @db.Decimal(12, 2)
  qstRate         Decimal? @db.Decimal(5, 3)
  qstAmount       Decimal? @db.Decimal(12, 2)
  totalAmount     Decimal  @db.Decimal(12, 2)

  // Deposit (first payment due on signing)
  depositAmount  Decimal? @db.Decimal(12, 2)
  depositPercent Decimal? @db.Decimal(5, 2)

  // Hourly rate for additional work
  hourlyRate Decimal? @db.Decimal(10, 2)

  // Credit card fee
  ccFeePercent Decimal? @default(3.5) @db.Decimal(5, 2)

  // Validity
  validUntil DateTime?
  validDays  Int?      @default(30)

  // E-signature fields
  signatureData String?   @db.Text // Base64 encoded signature image
  signedAt      DateTime?
  signedByName  String?
  signedByEmail String?
  signedByIp    String?
  signatureType String? // "drawn" | "typed"

  // Company signature (pre-filled)
  companySignature    String?   @db.Text // Base64 encoded signature
  companySignedByName String?
  companySignedAt     DateTime?

  // Access & tracking
  accessToken String    @unique @default(cuid())
  sentAt      DateTime?
  viewedAt    DateTime?

  // Deposit invoice auto-created on signing
  depositInvoiceCreated Boolean @default(false)

  // Metadata
  notes       String?  @db.Text
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  project    Project            @relation("ProjectProposals", fields: [projectId], references: [id], onDelete: Cascade)
  createdBy  User               @relation("ProposalCreatedBy", fields: [createdById], references: [id])
  activities ProposalActivity[]
  invoices   BillingInvoice[]   @relation("InvoiceFromProposal")

  @@unique([orgId, proposalNumber])
  @@index([orgId])
  @@index([projectId])
  @@index([status])
  @@index([accessToken])
  @@index([createdAt])
}

model ProposalActivity {
  id         String   @id @default(cuid())
  proposalId String
  type       String // CREATED, SENT, VIEWED, SIGNED, EXPIRED, etc.
  message    String
  metadata   Json?
  createdAt  DateTime @default(now())

  proposal Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  @@index([proposalId])
  @@index([createdAt])
}

enum BillingInvoiceStatus {
  DRAFT
  SENT
  VIEWED
  PARTIALLY_PAID
  PAID
  OVERDUE
  CANCELLED
  VOID
}

enum BillingInvoiceType {
  STANDARD
  DEPOSIT
  MILESTONE
  HOURLY
  FINAL
}

model BillingInvoice {
  id            String  @id @default(cuid())
  orgId         String
  projectId     String
  proposalId    String? // Optional link to proposal
  invoiceNumber String // e.g., "INV-2026-001"

  title       String
  description String?              @db.Text
  type        BillingInvoiceType   @default(STANDARD)
  status      BillingInvoiceStatus @default(DRAFT)

  // Client info
  clientName    String
  clientEmail   String
  clientPhone   String?
  clientAddress String? @db.Text

  // Pricing
  subtotal        Decimal  @db.Decimal(12, 2)
  discountPercent Decimal? @db.Decimal(5, 2)
  discountAmount  Decimal? @db.Decimal(12, 2)
  gstRate         Decimal? @db.Decimal(5, 3)
  gstAmount       Decimal? @db.Decimal(12, 2)
  qstRate         Decimal? @db.Decimal(5, 3)
  qstAmount       Decimal? @db.Decimal(12, 2)
  totalAmount     Decimal  @db.Decimal(12, 2)

  // Payment tracking
  depositPercent Decimal? @db.Decimal(5, 2)
  depositAmount  Decimal? @db.Decimal(12, 2)
  amountPaid     Decimal  @default(0) @db.Decimal(12, 2)
  balanceDue     Decimal  @db.Decimal(12, 2)

  // Dates
  issueDate    DateTime  @default(now())
  dueDate      DateTime?
  paidInFullAt DateTime?

  // Access
  accessToken String    @unique @default(cuid())
  sentAt      DateTime?
  viewedAt    DateTime?

  // Payment options
  allowCreditCard   Boolean  @default(true)
  ccFeePercent      Decimal? @default(2.9) @db.Decimal(5, 2)
  allowBankTransfer Boolean  @default(true)
  allowEtransfer    Boolean  @default(true)
  allowCheck        Boolean  @default(true)

  // Metadata
  notes              String?  @db.Text
  termsAndConditions String?  @db.Text
  createdById        String
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  project    Project                  @relation("ProjectBillingInvoices", fields: [projectId], references: [id], onDelete: Cascade)
  proposal   Proposal?                @relation("InvoiceFromProposal", fields: [proposalId], references: [id])
  createdBy  User                     @relation("BillingInvoiceCreatedBy", fields: [createdById], references: [id])
  lineItems  BillingInvoiceLineItem[]
  payments   BillingPayment[]
  activities BillingInvoiceActivity[]

  @@unique([orgId, invoiceNumber])
  @@index([orgId])
  @@index([projectId])
  @@index([proposalId])
  @@index([status])
  @@index([accessToken])
  @@index([dueDate])
  @@index([createdAt])
}

enum BillingLineItemType {
  FIXED
  HOURLY
  MILESTONE
  DEPOSIT
  ADJUSTMENT
}

model BillingInvoiceLineItem {
  id               String              @id @default(cuid())
  billingInvoiceId String
  type             BillingLineItemType @default(FIXED)

  description String
  quantity    Decimal @default(1) @db.Decimal(10, 2)
  unitPrice   Decimal @db.Decimal(12, 2)

  // For hourly billing
  hours        Decimal? @db.Decimal(10, 2)
  hourlyRate   Decimal? @db.Decimal(12, 2)
  timeEntryIds String[] // Links to TimeEntry records

  // For milestone billing
  milestoneTitle   String?
  milestonePercent Decimal? @db.Decimal(5, 2)

  // Computed
  amount Decimal @db.Decimal(12, 2)
  order  Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  billingInvoice BillingInvoice @relation(fields: [billingInvoiceId], references: [id], onDelete: Cascade)
  linkedTimeEntries TimeEntry[] @relation("LinkedTimeEntries")

  @@index([billingInvoiceId])
  @@index([order])
}

enum BillingPaymentStatus {
  PENDING
  CONFIRMED
  FAILED
  REFUNDED
}

enum BillingPaymentMethod {
  CREDIT_CARD
  WIRE_TRANSFER
  CHECK
  E_TRANSFER
  CASH
  OTHER
}

model BillingPayment {
  id               String @id @default(cuid())
  billingInvoiceId String

  amount Decimal              @db.Decimal(12, 2)
  method BillingPaymentMethod
  status BillingPaymentStatus @default(PENDING)

  // Payment details
  stripePaymentId String?
  checkNumber     String?
  wireReference   String?
  eTransferRef    String?

  // Timestamps
  paidAt        DateTime?
  confirmedAt   DateTime?
  confirmedById String?

  // Documentation
  proofDocumentUrl String?
  notes            String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  billingInvoice BillingInvoice @relation(fields: [billingInvoiceId], references: [id], onDelete: Cascade)
  confirmedBy    User?          @relation("BillingPaymentConfirmedBy", fields: [confirmedById], references: [id])

  @@index([billingInvoiceId])
  @@index([status])
  @@index([paidAt])
}

model BillingInvoiceActivity {
  id               String   @id @default(cuid())
  billingInvoiceId String
  type             String // CREATED, SENT, VIEWED, PAYMENT_RECEIVED, OVERDUE, etc.
  message          String
  metadata         Json?
  createdAt        DateTime @default(now())

  billingInvoice BillingInvoice @relation(fields: [billingInvoiceId], references: [id], onDelete: Cascade)

  @@index([billingInvoiceId])
  @@index([createdAt])
}

// Plaid bank connection for financial reconciliation
model PlaidConnection {
  id                 String    @id @default(cuid())
  orgId              String
  accessToken        String    // Plaid access token (encrypt in app layer)
  itemId             String    // Plaid item ID
  institutionId      String?
  institutionName    String?
  accounts           Json?     // [{accountId, name, type, mask}]
  status             String    @default("ACTIVE")
  transactionsCursor String?
  lastSyncedAt       DateTime?
  connectedById      String
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  connectedBy  User         @relation("PlaidConnectedBy", fields: [connectedById], references: [id])

  @@unique([orgId, itemId])
  @@index([orgId])
}
